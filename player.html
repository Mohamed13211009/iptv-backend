<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ù…Ø´ØºÙ„ Ø§Ù„Ø£Ø³Ø·ÙˆØ±Ø© TV</title>
<style>
  :root{
    --bg:#020617;
    --bg2:#020617;
    --muted:rgba(255,255,255,0.75);
    --accent:#22d3ee;
    --accent2:#a855f7;
  }
  *{box-sizing:border-box}
  html,body{
    margin:0;
    padding:0;
    height:100%;
    background:#000;
    color:#fff;
    font-family:system-ui,Roboto,Arial;
    direction:rtl;
  }
  body{
    display:flex;
    flex-direction:column;
  }

  /* Ø´Ø±ÙŠØ· Ø¹Ù„ÙˆÙŠ Ø¨Ø³ÙŠØ· Ù„Ù„Ø±Ø¬ÙˆØ¹ + Ø¹Ù†ÙˆØ§Ù† */
  .top-bar{
    position:fixed;
    top:0;right:0;left:0;
    height:46px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:0 10px;
    background:linear-gradient(90deg,rgba(0,0,0,0.9),rgba(15,23,42,0.9));
    z-index:20;
    transition:opacity .25s ease;
  }
  .top-bar.hidden{
    opacity:0;
    pointer-events:none;
  }
  .top-left,
  .top-right{
    display:flex;
    align-items:center;
    gap:8px;
  }
  .btn-top{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    padding:6px 10px;
    border-radius:999px;
    border:1px solid rgba(148,163,184,0.9);
    background:rgba(15,23,42,0.9);
    color:#e5e7eb;
    font-size:13px;
    cursor:pointer;
  }
  .btn-top span.icon{
    font-size:14px;
  }
  .title{
    font-size:14px;
    font-weight:700;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    max-width:200px;
  }

  /* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø´ØºÙ‘Ù„ */
  .player-wrap{
    position:fixed;
    inset:0;
    display:flex;
    align-items:center;
    justify-content:center;
    background:#000;
  }
  video{
    width:100%;
    height:100%;
    object-fit:contain; /* ÙŠÙ…Ù„Ø£ Ø§Ù„Ø´Ø§Ø´Ø© Ù…Ù† ØºÙŠØ± Ù‚Ø·Ø¹ */
    background:#000;
  }

  /* Ù„ÙˆØ¯ÙŠÙ†Ø¬ */
  .loader-overlay{
    position:fixed;
    inset:0;
    display:flex;
    align-items:center;
    justify-content:center;
    background:radial-gradient(circle at top,#020617 0,#000 70%);
    z-index:15;
  }
  .loader{
    width:42px;
    height:42px;
    border-radius:50%;
    border:4px solid rgba(148,163,184,0.25);
    border-top-color:var(--accent);
    border-right-color:var(--accent2);
    animation:spin .7s linear infinite;
  }
  @keyframes spin{
    to{transform:rotate(360deg);}
  }

  /* Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£ */
  .error-box{
    position:fixed;
    inset:0;
    display:flex;
    align-items:center;
    justify-content:center;
    background:#000;
    padding:20px;
    text-align:center;
  }
  .error-inner{
    max-width:320px;
  }
  .error-title{
    font-size:18px;
    margin-bottom:6px;
    font-weight:800;
  }
  .error-text{
    font-size:14px;
    color:var(--muted);
    margin-bottom:16px;
  }
  .error-btn{
    padding:8px 18px;
    background:linear-gradient(135deg,var(--accent),var(--accent2));
    border:none;
    border-radius:999px;
    font-size:14px;
    cursor:pointer;
    color:#0f172a;
    font-weight:700;
  }

  @media (orientation:landscape){
    .title{max-width:320px;}
  }
</style>
</head>
<body>

<!-- Ø´Ø±ÙŠØ· Ø¹Ù„ÙˆÙŠ -->
<div class="top-bar" id="topBar">
  <div class="top-left">
    <button class="btn-top" id="backBtn">
      <span class="icon">â¬…ï¸</span>
      <span>Ø±Ø¬ÙˆØ¹</span>
    </button>
  </div>
  <div class="top-right">
    <div class="title" id="videoTitle">Ø§Ù„Ø£Ø³Ø·ÙˆØ±Ø© TV</div>
  </div>
</div>

<!-- Ø§Ù„Ù…Ø´ØºÙ‘Ù„ -->
<div class="player-wrap">
  <video id="player" playsinline controls></video>
</div>

<!-- Ù„ÙˆØ¯ÙŠÙ†Ø¬ -->
<div class="loader-overlay" id="loader">
  <div class="loader"></div>
</div>

<!-- ØµÙ†Ø¯ÙˆÙ‚ Ø®Ø·Ø£ (ÙŠØ¸Ù‡Ø± Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©) -->
<div class="error-box" id="errorBox" style="display:none;">
  <div class="error-inner">
    <div class="error-title">ØªØ¹Ø°Ø± ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ</div>
    <div class="error-text" id="errorText">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø§Ø¨Ø·.</div>
    <button class="error-btn" onclick="location.reload()">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© ğŸ”</button>
  </div>
</div>

<script>
/*
  Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ù† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚:

  1) Ù„Ùˆ Ù…Ø¹Ø§Ùƒ Ù„ÙŠÙ†Ùƒ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù…Ø¨Ø§Ø´Ø±Ø©:
     https://USERNAME.github.io/iptv-player/player.html?url=ENCODED_URL&title=Ø§Ø³Ù…+Ø§Ù„ÙÙŠÙ„Ù…

     Ù…Ø«Ù€Ù€Ø§Ù„:
     url = encodeURIComponent('https://xtvip.net/live/...m3u8')

  2) Ù„Ùˆ Ø¹Ø§ÙŠØ² ØªØ³ØªØ®Ø¯Ù… Ø§Ù„Ø¨Ø§Ùƒ Ø¥Ù†Ø¯:
     Ø§Ø³ØªØ¨Ø¯Ù„ Ø§Ù„Ø¨Ø±Ø§Ù…ØªØ±Ø§Øª: ?id=123&type=vod
     ÙˆØ¹Ø¯Ù‘Ù„ Ø§Ù„Ø¯Ø§Ù„Ø© loadPlaylistFromBackend ØªØ­Øª Ø¹Ù„Ø´Ø§Ù† ØªØ·Ù„Ø¨ Ù…Ù† Ø§Ù„Ø¨Ø§Ùƒ Ø¥Ù†Ø¯.
*/

const player     = document.getElementById('player');
const loaderEl   = document.getElementById('loader');
const errorBox   = document.getElementById('errorBox');
const errorText  = document.getElementById('errorText');
const titleEl    = document.getElementById('videoTitle');
const topBar     = document.getElementById('topBar');
const backBtn    = document.getElementById('backBtn');

let playlist = [];
let currentIndex = 0;
let uiTimeout = null;

/* ====== Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨Ø±Ø§Ù…ÙŠØªØ±Ø² Ù…Ù† Ø§Ù„Ù€ URL ====== */
const params = new URLSearchParams(window.location.search);
const directUrlParam = params.get('url');
const titleParam     = params.get('title') || 'Ø§Ù„Ø£Ø³Ø·ÙˆØ±Ø© TV';
const idParam        = params.get('id');
const typeParam      = params.get('type') || 'vod';

titleEl.textContent = decodeURIComponent(titleParam);

/* Ø±Ø¬ÙˆØ¹ */
backBtn.addEventListener('click', () => {
  // Ù„Ùˆ Ø¬Ø§ÙŠ Ù…Ù† AppCreator 24 Ø¬ÙˆÙ‘Ù‡ Ø³ÙƒØ´Ù†
  if (document.referrer) {
    history.back();
  } else {
    // ÙÙŠ Ø£Ø³ÙˆØ£ Ø§Ù„Ø­Ø§Ù„Ø§Øª: Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø£Ø¨
    window.location.href = 'about:blank';
  }
});

/* Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØªÙˆØ¨ Ø¨Ø§Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠ */
function showUI(){
  topBar.classList.remove('hidden');
  if(uiTimeout) clearTimeout(uiTimeout);
  uiTimeout = setTimeout(()=> {
    if(!player.paused){
      topBar.classList.add('hidden');
    }
  }, 2500);
}
player.addEventListener('play', showUI);
player.addEventListener('pause', () => {
  topBar.classList.remove('hidden');
  if(uiTimeout) clearTimeout(uiTimeout);
});
player.addEventListener('click', showUI);
document.addEventListener('touchstart', showUI);

/* Ù‡Ø§Ù†Ø¯Ù„ Ø§Ù„Ø®Ø·Ø£ */
function fail(msg){
  loaderEl.style.display = 'none';
  errorBox.style.display = 'flex';
  errorText.textContent  = msg || 'ØªØ¹Ø°Ø± ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ.';
}

/* ØªØ´ØºÙŠÙ„ Ù…Ù† Ø§Ù„Ø¨Ù„Ø§ÙŠ Ù„ÙŠØ³Øª */
function playFromPlaylist(index){
  if(!playlist.length){
    fail('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ÙŠ Ø±Ø§Ø¨Ø· ØªØ´ØºÙŠÙ„ Ù…ØªØ§Ø­.');
    return;
  }
  if(index >= playlist.length){
    fail('ÙƒÙ„ Ù…ØµØ§Ø¯Ø± Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙØ´Ù„Øª ÙÙŠ Ø§Ù„ØªØ´ØºÙŠÙ„.');
    return;
  }
  currentIndex = index;
  const url = playlist[index];

  loaderEl.style.display = 'flex';
  errorBox.style.display = 'none';

  player.src = url;
  player.load();
  player.play()
    .then(()=>{
      loaderEl.style.display = 'none';
      showUI();
    })
    .catch(err=>{
      console.warn('Play error for url', url, err);
      // Ø¬Ø±Ù‘Ø¨ Ø§Ù„Ù„ÙŠÙ†Ùƒ Ø§Ù„Ù„ÙŠ Ø¨Ø¹Ø¯Ù‡
      playFromPlaylist(index+1);
    });

  player.onerror = () => {
    console.warn('HTML5 video error on', url);
    playFromPlaylist(index+1);
  };
}

/* ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨Ù„Ø§ÙŠ Ù„ÙŠØ³Øª Ù…Ù† Ø§Ù„Ø¨Ø§Ùƒ Ø¥Ù†Ø¯ (Ù„Ùˆ Ø­Ø§Ø¨Ø¨ ØªØ³ØªØ®Ø¯Ù…Ù‡) */
async function loadPlaylistFromBackend(id, type){
  // Ø¹Ø¯Ù‘Ù„ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø¯Ø§ Ø­Ø³Ø¨ Ø§Ù„Ø¨Ø§Ùƒ Ø¥Ù†Ø¯ Ø¨ØªØ§Ø¹Ùƒ:
  const BACKEND_BASE = 'https://iptv-backend-production-34ee.up.railway.app';
  const url = `${BACKEND_BASE}/playlist?id=${encodeURIComponent(id)}&type=${encodeURIComponent(type)}`;

  const res = await fetch(url, {cache:'no-store'});
  if(!res.ok) throw new Error('HTTP ' + res.status);
  const data = await res.json();

  if(!data || data.status !== 'ok' || !Array.isArray(data.playlist) || !data.playlist.length){
    throw new Error('Ø±Ø¯ ØºÙŠØ± ØµØ§Ù„Ø­ Ù…Ù† Ø®Ø§Ø¯Ù… Ø§Ù„Ø¨Ø«');
  }

  titleEl.textContent = data.title || titleParam;
  return data.playlist;
}

/* Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© */
(async function init(){
  try{
    if(directUrlParam){
      // ÙˆØ¶Ø¹ Ø¨Ø³ÙŠØ·: Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙŠØ¨Ø¹Ø« Ù„ÙŠÙ†Ùƒ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù…Ø¨Ø§Ø´Ø±Ø©
      const realUrl = decodeURIComponent(directUrlParam);
      playlist = [realUrl];
      playFromPlaylist(0);
    } else if(idParam){
      // ÙˆØ¶Ø¹ Ø§Ù„Ø¨Ø§Ùƒ Ø¥Ù†Ø¯: Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ ÙŠØ¨Ø¹Øª id + type
      playlist = await loadPlaylistFromBackend(idParam, typeParam);
      playFromPlaylist(0);
    } else {
      fail('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ø§Ø¨Ø· ØªØ´ØºÙŠÙ„ (url) Ø£Ùˆ Ù…Ø¹Ø±Ù (id) ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø·.');
    }
  }catch(err){
    console.error(err);
    fail('ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù….');
  }
})();
</script>
</body>
</html>
