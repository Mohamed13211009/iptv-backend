<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>watch free</title>
<style>
  :root{--bg:#000;--card:#071018;--muted:rgba(255,255,255,0.65);--accent:#6fe8ff}
  *{box-sizing:border-box} html,body{height:100%}
  body{
    margin:0;
    font-family:system-ui,Roboto,Arial;
    background:linear-gradient(180deg,#000,#051018);
    color:#fff;
    direction:rtl
  }

  .container{max-width:980px;margin:12px auto;padding:0 12px 80px}

  /* Ø§Ù„Ø³Ù„Ø§ÙŠØ¯Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯ */
  .hero-slider{
    width:100%;
    aspect-ratio:16/9;
    max-height:260px;
    border-radius:18px;
    overflow:hidden;
    position:relative;
    margin:8px 0 14px;
    background:#050b10;
  }
  @media (max-width:480px){
    .hero-slider{
      border-radius:14px;
      margin:4px 0 10px;
    }
  }
  .hero-track{
    width:100%;
    height:100%;
    display:flex;
    transition:transform .5s ease;
    will-change:transform;
  }
  .hero-slide{
    flex:0 0 100%;
    height:100%;
    position:relative;
    cursor:pointer;
  }
  .hero-bg{
    position:absolute;
    inset:0;
    background-size:cover;
    background-position:center;
    filter:brightness(0.78);
  }
  .hero-overlay{
    position:absolute;
    inset:0;
    background:linear-gradient(180deg,rgba(0,0,0,0.15),rgba(0,0,0,0.85));
  }
  .hero-info{
    position:absolute;
    left:14px;
    right:14px;
    bottom:14px;
  }
  .hero-type{
    font-size:12px;
    color:var(--accent);
    margin-bottom:4px;
    font-weight:600;
  }
  .hero-title{
    font-size:18px;
    font-weight:800;
    margin-bottom:4px;
  }
  .hero-meta{
    font-size:13px;
    color:var(--muted);
  }
  .hero-dots{
    position:absolute;
    bottom:10px;
    left:50%;
    transform:translateX(-50%);
    display:flex;
    align-items:center;
    gap:6px;
    z-index:4;
  }
  .hero-dot{
    width:8px;
    height:8px;
    border-radius:50%;
    background:rgba(255,255,255,0.35);
    cursor:pointer;
  }
  .hero-dot.active{
    background:#fff;
  }

  .section{margin:18px 0}
  .hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
  .hdr .title{font-weight:800}
  .hdr .more{color:var(--muted);font-weight:700;cursor:pointer}
  .row-scroll{
    display:flex;gap:14px;overflow-x:auto;
    padding-bottom:6px;scroll-snap-type:x mandatory
  }
  .item{
    flex:0 0 auto;width:130px;scroll-snap-align:start;
    display:flex;flex-direction:column;align-items:center;
    gap:8px;cursor:pointer
  }
  .thumb{
    width:110px;height:178px;border-radius:14px;overflow:hidden;
    background:#0b0f13;display:flex;align-items:center;
    justify-content:center;border:2px solid rgba(255,255,255,0.03)
  }
  .thumb img{width:100%;height:100%;object-fit:cover;display:block}
  .name{font-size:13px;color:var(--muted);text-align:center}

  #playerPage{
    display:none;position:fixed;inset:0;z-index:300;
    background:#000;align-items:center;justify-content:center
  }
  #player{
    width:100%;
    max-height:100vh;
    min-height:220px;
    background:#000;
    object-fit:contain;
  }
  .player-top{
    position:absolute;top:10px;left:12px;right:12px;
    display:flex;justify-content:space-between;align-items:center;z-index:310
  }
  .player-rotate-wrap{
    position:absolute;
    bottom:20px;
    left:50%;
    transform:translateX(-50%);
    z-index:310;
  }
  .rotate-btn{
    background:rgba(0,0,0,0.65);
    color:#fff;
    border:none;
    padding:10px 18px;
    border-radius:999px;
    font-weight:700;
    font-size:15px;
    display:flex;
    align-items:center;
    gap:6px;
    cursor:pointer;
  }
  .bottom-nav{
    position:fixed;left:0;right:0;bottom:0;height:68px;
    background:linear-gradient(180deg,transparent,rgba(0,0,0,0.6));
    display:flex;align-items:center;justify-content:center;z-index:320
  }
  .nav-inner{
    width:100%;max-width:980px;display:flex;
    justify-content:space-around;align-items:center;padding:8px
  }
  .tab{
    flex:1;display:flex;flex-direction:column;
    align-items:center;gap:6px;cursor:pointer
  }
  .icon-bar{
    width:34px;height:10px;background:rgba(255,255,255,0.1);border-radius:4px
  }
  .active .icon-bar{background:var(--accent)}
  .label{font-size:14px;color:var(--muted)}

  #seriesPage{
    display:none;position:fixed;inset:0;
    background:linear-gradient(180deg,rgba(0,0,0,0.92),rgba(0,0,0,0.96));
    z-index:400;overflow-y:auto;padding:18px
  }
  #seriesTitleHeader{
    text-align:center;
    margin:0 0 10px 0;
    font-size:22px;
    font-weight:800;
  }
  .seasonsBar{
    display:flex;gap:8px;margin:6px 0 4px;
    overflow-x:auto;padding-bottom:4px
  }
  .seasonChip{
    flex:0 0 auto;border-radius:999px;
    border:1px solid rgba(255,255,255,0.2);
    padding:6px 12px;font-size:13px;color:var(--muted);
    cursor:pointer;white-space:nowrap;background:rgba(0,0,0,0.25)
  }
  .seasonChip.active{
    background:var(--accent);color:#012;
    border-color:transparent;font-weight:700
  }
  .episodesGrid{
    display:grid;
    grid-template-columns:repeat(3,110px);
    justify-content:center;
    gap:12px;
    margin-top:10px;
  }
  .episodeItem{
    width:110px;
    background:var(--card);
    border-radius:12px;
    overflow:hidden;
    cursor:pointer;
    display:flex;
    flex-direction:column;
  }
  .episodeThumb{
    width:110px;
    height:180px;
    object-fit:cover;
    display:block;
  }
  .episodeMeta{
    padding:6px 6px 8px;
  }
  .episodeTitle{
    font-size:12px;
    font-weight:700;
    text-align:center;
  }

  #imageViewer{
    display:none;position:fixed;inset:0;
    z-index:350;background:#000;align-items:center;justify-content:center
  }
  #imageViewEl{
    max-width:100%;max-height:100%;object-fit:contain
  }

  .muted{color:var(--muted);font-size:14px}

  .page{min-height:calc(100vh - 90px);}
  .page-title{
    margin:6px 0 10px;
    font-size:20px;
    font-weight:800;
  }
</style>
</head>
<body>

<main class="container">

  <!-- Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
  <div id="homePage" class="page">
    <div id="appUI">
      <div class="hero-slider">
        <div class="hero-track" id="homeSliderTrack"></div>
        <div class="hero-dots" id="homeSliderDots"></div>
      </div>
      <div id="sectionsContainer"></div>
    </div>
  </div>

  <!-- Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø± -->
  <div id="livePage" class="page" style="display:none">
    <h2 class="page-title">Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</h2>
    <div class="hero-slider">
      <div class="hero-track" id="liveSliderTrack"></div>
      <div class="hero-dots" id="liveSliderDots"></div>
    </div>
    <div id="liveSections"></div>
  </div>

  <!-- Ø§Ù„Ø£ÙÙ„Ø§Ù… -->
  <div id="moviesPage" class="page" style="display:none">
    <h2 class="page-title">Ø§Ù„Ø£ÙÙ„Ø§Ù…</h2>
    <div class="hero-slider">
      <div class="hero-track" id="moviesSliderTrack"></div>
      <div class="hero-dots" id="moviesSliderDots"></div>
    </div>
    <div id="moviesSections"></div>
  </div>

  <!-- Ø§Ù„Ù…Ø³Ù„Ø³Ù„Ø§Øª -->
  <div id="seriesMainPage" class="page" style="display:none">
    <h2 class="page-title">Ø§Ù„Ù…Ø³Ù„Ø³Ù„Ø§Øª</h2>
    <div class="hero-slider">
      <div class="hero-track" id="seriesSliderTrack"></div>
      <div class="hero-dots" id="seriesSliderDots"></div>
    </div>
    <div id="seriesSections"></div>
  </div>

</main>

<!-- ØµÙØ­Ø© Ø§Ù„Ø­Ù„Ù‚Ø§Øª -->
<div id="seriesPage">
  <div style="margin-bottom:8px;display:flex;justify-content:flex-end">
    <button onclick="closeSeries()" style="background:#2196f3;color:#012;border:none;padding:8px 12px;border-radius:10px">â¬…ï¸ Ø±Ø¬ÙˆØ¹</button>
  </div>
  <h2 id="seriesTitleHeader"></h2>
  <div class="content" id="seriesContent"></div>
</div>

<!-- Ø§Ù„Ù…Ø´ØºÙ„ -->
<div id="playerPage">
  <div class="player-top">
    <button onclick="closePlayer()" style="background:#e53935;color:#fff;border:none;padding:8px 10px;border-radius:8px;font-weight:700">â¬…ï¸ Ø±Ø¬ÙˆØ¹</button>
    <div style="display:flex;gap:8px">
      <button onclick="toggleCinema()" style="background:rgba(255,255,255,0.06);color:#fff;border:none;padding:8px 10px;border-radius:8px">ğŸï¸</button>
    </div>
  </div>
  <video id="player" controls playsinline></video>

  <div class="player-rotate-wrap">
    <button class="rotate-btn" onclick="toggleRotate()">ğŸ”„ ØªØ¯ÙˆÙŠØ±</button>
  </div>
</div>

<!-- Ø§Ø³ØªØ¹Ø±Ø§Ø¶ Ø§Ù„ØµÙˆØ± -->
<div id="imageViewer">
  <div class="player-top">
    <button onclick="closeImageViewer()" style="background:rgba(255,255,255,0.06);color:#fff;border:none;padding:8px 10px;border-radius:8px">â¬…ï¸ Ø±Ø¬ÙˆØ¹</button>
  </div>
  <img id="imageViewEl" src="" alt="">
</div>

<!-- Ø´Ø±ÙŠØ· ØªØ­Øª -->
<div class="bottom-nav">
  <div class="nav-inner" id="navInner">
    <div class="tab active" data-target="home"><div class="icon-bar"></div><div class="label">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div></div>
    <div class="tab" data-target="live"><div class="icon-bar"></div><div class="label">Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</div></div>
    <div class="tab" data-target="movies"><div class="icon-bar"></div><div class="label">Ø§Ù„Ø£ÙÙ„Ø§Ù…</div></div>
    <div class="tab" data-target="series"><div class="icon-bar"></div><div class="label">Ø§Ù„Ù…Ø³Ù„Ø³Ù„Ø§Øª</div></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/hls.js@1"></script>
<script>
// =================== Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø³ÙŠØ±ÙØ±Ø§Øª ===================

// Ø§Ù„Ø³ÙŠØ±ÙØ± Ø§Ù„Ù…Ø­Ù…ÙŠ Ø¹Ù„Ù‰ Railway (Ù„Ùˆ Ø­Ø§Ø¨Ø¨ ØªØ³ØªØ®Ø¯Ù…Ù‡)
const PROTECTED_API = 'https://iptv-backend-production-34ee.up.railway.app';

// Ø³ÙŠØ±ÙØ± Xtream Ø§Ù„Ø±Ø³Ù…ÙŠ (Ù‡Ù†Ø§ Ø§Ù„ÙˆÙ‡Ù…ÙŠ)
const XTREAM_SERVER = 'http://xtvip.net';
const XTREAM_USER   = 'watch1235';
const XTREAM_PASS   = '742837399';

const sessionUser = {
  server: XTREAM_SERVER,
  user:   XTREAM_USER,
  pass:   XTREAM_PASS
};

const apiSession = {
  token: null,
  expiresAt: 0
};

let cache = {
  movies: [],
  series: [],
  live: [],
  vodCats: [],
  seriesCats: [],
  liveCats: []
};

const MAX_ITEMS_PER_SECTION = {
  movies: 200,
  series: 200,
  live:   200
};

// ============ Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© Ø¹Ø§Ù…Ø© ============

function extractArray(resp){
  if(Array.isArray(resp)) return resp;
  if(resp && typeof resp === 'object'){
    const keys=['data','items','result','streams','response','rows','videos','channels','list','categories','episodes','live_categories'];
    for(const k of keys) if(Array.isArray(resp[k])) return resp[k];
    for(const k in resp) if(Array.isArray(resp[k])) return resp[k];
  }
  return null;
}

async function fetchJson(url, opts={}, timeout=12000){
  const controller = new AbortController();
  const id = setTimeout(()=>controller.abort(), timeout);
  try{
    const res = await fetch(url, {...opts, signal:controller.signal, cache:'no-store'});
    clearTimeout(id);
    if(!res.ok) throw new Error('HTTP ' + res.status);
    return await res.json();
  }catch(e){ clearTimeout(id); throw e; }
}

// ================== Ø¬Ù„Ø¨ Ø¯Ø§ØªØ§ Ù…Ù† xtream ==================

async function fetchSection(action){
  if(!sessionUser.server || !sessionUser.user || !sessionUser.pass) {
    throw new Error('missing credentials');
  }
  const base = sessionUser.server.replace(/\/$/,'');
  const url  = `${base}/player_api.php?username=${encodeURIComponent(sessionUser.user)}&password=${encodeURIComponent(sessionUser.pass)}&action=${encodeURIComponent(action)}`;
  const json = await fetchJson(url);
  const arr  = extractArray(json);
  if(arr === null) throw new Error('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØµÙÙˆÙØ© ÙÙŠ Ø±Ø¯ Ø§Ù„Ø³ÙŠØ±ÙØ±');
  return arr;
}

// ============ ÙƒØ§Ø´ Ù…Ø­Ù„ÙŠ ============

function cacheKey(id){ return 'iptv_cache_' + id; }

function saveCache(id,data){
  try{
    localStorage.setItem(cacheKey(id), JSON.stringify({ts:Date.now(),data}));
  }catch(e){}
}

function loadCache(id){
  try{
    const raw = localStorage.getItem(cacheKey(id));
    if(!raw) return null;
    const o=JSON.parse(raw);
    if(!o || !o.data) return null;
    const age = Date.now() - (o.ts || 0);
    if(age > 1000*60*60*6) return null; // 6 Ø³Ø§Ø¹Ø§Øª
    return o.data;
  }catch(e){return null}
}

function getItemKey(it){
  return (
    it.stream_id ||
    it.series_id ||
    it.movie_id ||
    it.id ||
    it.channel_id ||
    it.epg_id ||
    (it.name && it.stream_type ? it.name + '_' + it.stream_type : it.name || null)
  );
}

function mergeLists(oldList, newList){
  const result = [];
  const seen = new Set();

  (newList || []).forEach(it=>{
    const k = getItemKey(it);
    if(!k || seen.has(k)) return;
    seen.add(k);
    result.push(it);
  });

  (oldList || []).forEach(it=>{
    const k = getItemKey(it);
    if(!k || seen.has(k)) return;
    seen.add(k);
    result.push(it);
  });

  return result;
}

// ============ ØªØ­Ù…ÙŠÙ„ ÙƒÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… ============

async function loadAllSections(useCacheOnly=false){
  cache.movies     = loadCache('movies')     || cache.movies     || [];
  cache.series     = loadCache('series')     || cache.series     || [];
  cache.live       = loadCache('live')       || cache.live       || [];
  cache.vodCats    = loadCache('vodCats')    || cache.vodCats    || [];
  cache.seriesCats = loadCache('seriesCats') || cache.seriesCats || [];
  cache.liveCats   = loadCache('liveCats')   || cache.liveCats   || [];

  if((cache.vodCats.length || cache.seriesCats.length || cache.liveCats.length) &&
     (cache.movies.length || cache.series.length || cache.live.length)){
    renderAllSections();
    buildSlidesFromCache();
    renderAllSliders();
  }else{
    const homeContainer = document.getElementById('sectionsContainer');
    if(homeContainer) homeContainer.innerHTML = '<div class="muted">...Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</div>';
  }

  if(useCacheOnly) return;

  try{
    const [
      moviesFresh,
      seriesFresh,
      vodCatsFresh,
      seriesCatsFresh,
      liveFresh,
      liveCatsFresh
    ] = await Promise.all([
      fetchSection('get_vod_streams'),
      fetchSection('get_series'),
      fetchSection('get_vod_categories'),
      fetchSection('get_series_categories'),
      fetchSection('get_live_streams'),
      fetchSection('get_live_categories')
    ]);

    const limitMovies = MAX_ITEMS_PER_SECTION.movies || 200;
    const limitSeries = MAX_ITEMS_PER_SECTION.series || 200;
    const limitLive   = MAX_ITEMS_PER_SECTION.live   || 200;

    cache.movies     = mergeLists(cache.movies, moviesFresh).slice(0, limitMovies);
    cache.series     = mergeLists(cache.series, seriesFresh).slice(0, limitSeries);
    cache.live       = mergeLists(cache.live,   liveFresh).slice(0, limitLive);
    cache.vodCats    = vodCatsFresh    || [];
    cache.seriesCats = seriesCatsFresh || [];
    cache.liveCats   = liveCatsFresh   || [];

    saveCache('movies', cache.movies);
    saveCache('series', cache.series);
    saveCache('live',   cache.live);
    saveCache('vodCats', cache.vodCats);
    saveCache('seriesCats', cache.seriesCats);
    saveCache('liveCats', cache.liveCats);

    renderAllSections();
    buildSlidesFromCache();
    renderAllSliders();
  }catch(e){
    console.warn('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±', e);
    const homeContainer = document.getElementById('sectionsContainer');
    if(homeContainer && !cache.movies.length && !cache.series.length && !cache.live.length){
      homeContainer.innerHTML = '<div class="muted">ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</div>';
    }
  }
}

function renderAllSections(){
  renderCategorySections('sectionsContainer', 'all', true);
  renderCategorySections('liveSections', 'live', false);
  renderCategorySections('moviesSections', 'movies', false);
  renderCategorySections('seriesSections', 'series', false);
}

// ============ Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¹Ù†Ø§ØµØ± ============

function renderRowElement(rowEl, items){
  rowEl.innerHTML = '';
  if(!items || !items.length){
    rowEl.innerHTML = '<div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</div>';
    return;
  }
  items.forEach(it=> rowEl.appendChild(makeItem(it)));
}

function makeItem(obj){
  const it = document.createElement('div'); it.className='item';
  const thumb = document.createElement('div'); thumb.className='thumb';
  const img = document.createElement('img'); img.loading='lazy';
  img.src = obj.stream_icon||obj.icon||obj.tv_series_thumb||obj.cover||obj.poster||'https://via.placeholder.com/320x180?text=No+Image';
  img.onerror = ()=>{ img.src='https://via.placeholder.com/320x180?text=No+Image'; };
  thumb.appendChild(img);
  const name = document.createElement('div'); name.className='name'; name.textContent = obj.name||obj.title||obj.channel||'Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†';
  it.appendChild(thumb); it.appendChild(name);

  const type = guessSectionType(obj);
  if(type === 'series'){
    it.addEventListener('click', ()=> openSeries(obj));
  }else{
    it.addEventListener('click', ()=> openPlayerOrFallback(obj,false));
  }

  return it;
}

function guessSectionType(item){
  if(item.stream_type && /live/i.test(item.stream_type)) return 'live';
  if(item.tv_series_id || item.series_id || item.vod_type === 'series' || item.episode_id || item.season || (item.category && /series|Ù…Ø³Ù„Ø³Ù„/i.test(item.category)))
    return 'series';
  return 'vod';
}

function getExtFromItem(item){
  let ext = (item.container_extension || item.ext || '').toString().toLowerCase().replace(/^\./,'');
  if(!ext && item.url){
    try{
      const u = new URL(item.url, window.location.href);
      const m = u.pathname.match(/\.([^.\/]+)$/);
      if(m) ext = m[1].toLowerCase();
    }catch(e){}
  }
  return ext;
}

function getExtFromUrl(url, fallback){
  try{
    const u = new URL(url, window.location.href);
    const m = u.pathname.match(/\.([^.\/]+)$/);
    if(m) return m[1].toLowerCase();
  }catch(e){}
  return (fallback||'').toLowerCase().replace(/^\./,'');
}

// ============ Ø¨Ù†Ø§Ø¡ Ø±ÙˆØ§Ø¨Ø· Ø§Ù„ØªØ´ØºÙŠÙ„ ============

function buildCandidateUrls(item, token){
  const urls = [];
  const baseXtream = sessionUser.server.replace(/\/$/,'');
  const user = encodeURIComponent(sessionUser.user);
  const pass = encodeURIComponent(sessionUser.pass);
  const type = guessSectionType(item);
  const ext  = getExtFromItem(item);

  const sid =
    item.stream_id ||
    item.episode_id ||
    item.id ||
    item.series_id ||
    item.movie_id ||
    item.channel_id;

  const direct = item.url || item.file || item.play_url || item.stream_url;
  if(direct) urls.push(direct);

  if(token && PROTECTED_API && sid){
    const pBase = PROTECTED_API.replace(/\/$/,'');
    urls.push(`${pBase}/stream/${encodeURIComponent(sid)}?token=${encodeURIComponent(token)}`);
  }

  if(!sid) return [...new Set(urls)];

  const add = (u)=>{ if(u && !urls.includes(u)) urls.push(u); };

  if(type === 'series'){
    if(ext) add(`${baseXtream}/series/${user}/${pass}/${sid}.${ext}`);
    add(`${baseXtream}/series/${user}/${pass}/${sid}.mp4`);
  }
  if(type === 'vod' || type === 'series'){
    if(ext) add(`${baseXtream}/movie/${user}/${pass}/${sid}.${ext}`);
    add(`${baseXtream}/movie/${user}/${pass}/${sid}.mp4`);
  }

  add(`${baseXtream}/live/${user}/${pass}/${sid}.m3u8`);
  add(`${baseXtream}/live/${user}/${pass}/${sid}.ts`);

  return urls;
}

// ============ ØªØµÙ†ÙŠÙØ§Øª ÙƒØ£Ù‚Ø³Ø§Ù… ============

function buildCategories(kind){
  const items = cache[kind] || [];
  let cats = [];

  if(kind === 'movies')      cats = cache.vodCats    || [];
  else if(kind === 'series') cats = cache.seriesCats || [];
  else if(kind === 'live')   cats = cache.liveCats   || [];

  const result = [];

  if(cats && cats.length){
    cats.forEach(cat=>{
      const id = String(cat.category_id || cat.category || cat.id || '');
      if(!id) return;
      const name = cat.category_name || cat.category_name_ar || cat.name || 'ØªØµÙ†ÙŠÙ';
      const catItems = items.filter(it => String(it.category_id||it.category||'') === id);
      if(catItems.length){
        result.push({id, name, kind, items:catItems});
      }
    });
  }else if(items.length){
    const name = kind==='live' ? 'ÙƒÙ„ Ø§Ù„Ù‚Ù†ÙˆØ§Øª' : 'Ø§Ù„ÙƒÙ„';
    result.push({id:'all', name, kind, items});
  }

  return result;
}

function renderCategorySections(containerId, kindFilter, withMoreButton){
  const container = document.getElementById(containerId);
  if(!container) return;

  container.innerHTML = '';

  const movieCats  = buildCategories('movies');
  const seriesCats = buildCategories('series');
  const liveCats   = buildCategories('live');

  let allCats = [];
  if(kindFilter === 'movies')      allCats = movieCats;
  else if(kindFilter === 'series') allCats = seriesCats;
  else if(kindFilter === 'live')   allCats = liveCats;
  else {
    allCats = [...liveCats, ...movieCats, ...seriesCats];
  }

  if(!allCats.length){
    const emptySec = document.createElement('section');
    emptySec.className='section';
    emptySec.innerHTML = '<div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ù‚Ø³Ø§Ù… Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹</div>';
    container.appendChild(emptySec);
    return;
  }

  allCats.forEach(cat=>{
    const sec = document.createElement('section');
    sec.className = 'section category-section';
    sec.dataset.kind = cat.kind;
    const rowId = `cat-${cat.kind}-${cat.id}-row`;

    const moreHtml = withMoreButton
      ? `<div class="more" data-type="${cat.kind}" data-section="${rowId}">Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø²ÙŠØ¯</div>`
      : '<div></div>';

    sec.innerHTML = `
      <div class="hdr">
        <div class="title">${cat.name}</div>
        ${moreHtml}
      </div>
      <div class="row-scroll" id="${rowId}"></div>
    `;
    container.appendChild(sec);
    const row = sec.querySelector('#'+CSS.escape(rowId));
    renderRowElement(row, cat.items);
  });
}

// ============ ØµÙØ­Ø© Ø§Ù„Ù…Ø³Ù„Ø³Ù„ / Ø§Ù„Ø­Ù„Ù‚Ø§Øª ============

async function openSeries(seriesObj){
  document.getElementById('seriesPage').style.display='block';
  const content = document.getElementById('seriesContent');
  content.innerHTML = '<div class="muted">ØªØ­Ù…ÙŠÙ„ Ø­Ù„Ù‚Ø§Øª...</div>';

  const titleText = seriesObj.name || seriesObj.title || 'Ø§Ù„Ù…Ø³Ù„Ø³Ù„';
  document.getElementById('seriesTitleHeader').textContent = titleText;

  let episodesData = seriesObj.episodes || seriesObj.videos || null;

  if(!episodesData && (seriesObj.tv_series_id || seriesObj.series_id)){
    try{
      const idv  = seriesObj.tv_series_id || seriesObj.series_id;
      const base = sessionUser.server.replace(/\/$/,'');
      const url  = `${base}/player_api.php?username=${encodeURIComponent(sessionUser.user)}&password=${encodeURIComponent(sessionUser.pass)}&action=get_series_info&series_id=${encodeURIComponent(idv)}`;
      const json = await fetchJson(url);
      episodesData = json?.episodes || extractArray(json) || null;
    }catch(e){
      console.warn('failed to fetch episodes', e);
    }
  }

  if(!episodesData){
    content.innerHTML = '<div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ù„Ù‚Ø§Øª Ù…ØªØ§Ø­Ø©</div>';
    return;
  }

  let episodesBySeason = {};
  if(Array.isArray(episodesData)){
    episodesBySeason['1'] = episodesData;
  } else if(typeof episodesData === 'object'){
    Object.keys(episodesData).forEach(seasonKey=>{
      const list = episodesData[seasonKey];
      if(Array.isArray(list) && list.length){
        episodesBySeason[seasonKey] = list;
      }
    });
  }

  const seasonKeys = Object.keys(episodesBySeason);
  if(!seasonKeys.length){
    content.innerHTML = '<div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ù„Ù‚Ø§Øª Ù…ØªØ§Ø­Ø©</div>';
    return;
  }

  content.innerHTML = '';
  const seasonsBar = document.createElement('div');
  seasonsBar.className = 'seasonsBar';
  content.appendChild(seasonsBar);

  const episodesGrid = document.createElement('div');
  episodesGrid.className = 'episodesGrid';
  content.appendChild(episodesGrid);

  let currentSeason = seasonKeys[0];

  function renderSeasonsBar(){
    seasonsBar.innerHTML = '';
    seasonKeys.forEach(key=>{
      const chip = document.createElement('div');
      chip.className = 'seasonChip' + (key === currentSeason ? ' active' : '');
      chip.textContent = `Ø§Ù„Ù…ÙˆØ³Ù… ${key}`;
      chip.addEventListener('click', ()=>{
        currentSeason = key;
        renderSeasonsBar();
        renderEpisodes();
      });
      seasonsBar.appendChild(chip);
    });
  }

  function renderEpisodes(){
    episodesGrid.innerHTML = '';
    const eps = episodesBySeason[currentSeason] || [];
    if(!eps.length){
      episodesGrid.innerHTML = '<div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ù„Ù‚Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ³Ù…</div>';
      return;
    }

    eps.forEach(ep=>{
      const card = document.createElement('div');
      card.className='episodeItem';

      const thumbSrc =
        (ep.info && (ep.info.movie_image || ep.info.cover || ep.info.movie_image_big)) ||
        ep.stream_icon || ep.icon || ep.image ||
        seriesObj.tv_series_thumb || seriesObj.cover || seriesObj.stream_icon ||
        'https://via.placeholder.com/110x180?text=No+Image';

      const img = document.createElement('img');
      img.className = 'episodeThumb';
      img.src = thumbSrc;
      img.onerror = ()=>{ img.src='https://via.placeholder.com/110x180?text=No+Image'; };

      const meta = document.createElement('div');
      meta.className = 'episodeMeta';

      const title = document.createElement('div');
      title.className = 'episodeTitle';
      title.textContent = ep.title||ep.name||ep.episode||'Ø­Ù„Ù‚Ø©';

      meta.appendChild(title);

      card.appendChild(img);
      card.appendChild(meta);

      card.addEventListener('click', ()=>{
        closeSeries();
        openPlayerOrFallback(ep,true);
      });

      episodesGrid.appendChild(card);
    });
  }

  renderSeasonsBar();
  renderEpisodes();
}

function closeSeries(){ document.getElementById('seriesPage').style.display='none'; }

// ================== Ø§Ù„ØªÙˆÙƒÙ† Ù…Ø¹ Ø§Ù„Ø³ÙŠØ±ÙØ± Ø§Ù„Ù…Ø­Ù…ÙŠ (Ù„Ùˆ Ø­Ø§Ø¨Ø¨ ØªØ³ØªØ®Ø¯Ù…Ù‡) ==================

async function getApiToken(){
  if(!PROTECTED_API) throw new Error('no protected api');
  const base = PROTECTED_API.replace(/\/$/,'');
  const data = await fetchJson(`${base}/token`);
  if(!data || !data.token) throw new Error('token missing');
  return {
    token: data.token,
    expiresAt: data.expiresAt || (Date.now() + 60*60*1000)
  };
}

async function ensureApiToken(){
  const now = Date.now();
  if(apiSession.token && apiSession.expiresAt && apiSession.expiresAt > now + 10*1000){
    return apiSession.token;
  }
  const t = await getApiToken();
  apiSession.token    = t.token;
  apiSession.expiresAt = t.expiresAt;
  return apiSession.token;
}

// ================== PLAYER + IMAGE VIEWER ==================

const playerPage = document.getElementById('playerPage');
const playerEl = document.getElementById('player');
const bottomNav = document.querySelector('.bottom-nav');
let currentHls = null;
let currentPlaylist = null;
let currentIndex = 0;
let fromSeries = false;
let stoppingPlayback = false;
let isRotated = false;

const imageViewer = document.getElementById('imageViewer');
const imageViewEl = document.getElementById('imageViewEl');

function openImageViewer(src){
  if(!src) return;
  imageViewEl.src = src;
  imageViewer.style.display='flex';
  playerPage.style.display='none';
}
function closeImageViewer(){
  imageViewEl.src = '';
  imageViewer.style.display='none';
}

function playFromPlaylist(index){
  if(stoppingPlayback) return;
  if(!currentPlaylist || !currentPlaylist.length) return;

  if(index >= currentPlaylist.length){
    if(!stoppingPlayback){
      alert('ØªØ¹Ø°Ø± ØªØ´ØºÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„Ù…ØµØ¯Ø±');
    }
    return;
  }

  currentIndex = index;
  const url = currentPlaylist[index];

  const ext = getExtFromUrl(url);
  const clean = url.split('?')[0].toLowerCase();

  const isImage = /\.(jpe?g|png|gif|webp|avif|bmp)$/.test(clean);
  const isHls = ext === 'm3u8' || /m3u8/i.test(clean);

  try{
    if(currentHls){ currentHls.destroy(); currentHls=null; }
  }catch(e){}
  playerEl.onerror = null;

  if(isImage){
    playerEl.pause(); playerEl.src='';
    openImageViewer(url);
    return;
  }

  closeImageViewer();

  const tryNext = ()=>{ if(stoppingPlayback) return; playFromPlaylist(index+1); };

  if(isHls && window.Hls && Hls.isSupported()){
    currentHls = new Hls({maxBufferLength:60});
    currentHls.loadSource(url);
    currentHls.attachMedia(playerEl);
    currentHls.on(Hls.Events.MANIFEST_PARSED, ()=> {
      if(stoppingPlayback) return;
      playerEl.play().catch(()=>{});
    });
    currentHls.on(Hls.Events.ERROR, (ev,data)=>{
      if(data && data.fatal){
        try{ currentHls.destroy(); }catch(e){}
        currentHls=null;
        tryNext();
      }
    });
  } else {
    playerEl.src = url;
    playerEl.load();
    playerEl.play().catch(()=>{});
    playerEl.onerror = ()=>{ tryNext(); };
  }

  playerPage.style.display='flex';
  if(bottomNav) bottomNav.style.display = 'none';
  adjustPlayerForOrientation();
}

async function openPlayerOrFallback(item, isEpisodeFromSeries){
  fromSeries = !!isEpisodeFromSeries;
  stoppingPlayback = false;
  isRotated = false;
  document.body.style.overflow='';
  adjustPlayerForOrientation();

  if(!sessionUser){
    alert('Ø³Ø¬Ù‘Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹');
    return;
  }

  let token = null;
  if(PROTECTED_API){
    try{
      token = await ensureApiToken();
    }catch(e){
      console.warn('ÙØ´Ù„ Ø¬Ù„Ø¨ ØªÙˆÙƒÙ† Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± Ø§Ù„Ù…Ø­Ù…ÙŠØŒ Ù‡ÙŠØªÙ… Ø§Ù„ØªØ´ØºÙŠÙ„ Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± Ø§Ù„Ø¹Ø§Ø¯ÙŠ', e);
    }
  }

  const candidates = buildCandidateUrls(item, token);
  if(!candidates.length){
    alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ø§Ø¨Ø· ØªØ´ØºÙŠÙ„ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù†ØµØ±');
    return;
  }
  currentPlaylist = candidates;
  playFromPlaylist(0);
}

function closePlayer(){
  stoppingPlayback = true;
  try{
    playerEl.onerror = null;
    if(currentHls){ currentHls.destroy(); currentHls=null; }
    playerEl.pause();
    playerEl.removeAttribute('src');
    playerEl.load();
  }catch(e){}
  currentPlaylist = null;
  currentIndex = 0;
  playerPage.style.display='none';
  if(bottomNav) bottomNav.style.display = 'flex';
  document.body.style.overflow='';
  isRotated = false;

  if(fromSeries){
    const sPage = document.getElementById('seriesPage');
    if(sPage) sPage.style.display='block';
  }
  fromSeries = false;

  setTimeout(()=>{ stoppingPlayback = false; }, 150);
}

function toggleRotate(){
  isRotated = !isRotated;
  if(isRotated){
    document.body.style.overflow='hidden';
  }else{
    document.body.style.overflow='';
  }
  adjustPlayerForOrientation();
}

function toggleCinema(){
  if(!document.fullscreenElement) playerEl.requestFullscreen?.().catch(()=>{});
  else document.exitFullscreen?.();
}

function adjustPlayerForOrientation(){
  const isLandscape = window.innerWidth > window.innerHeight;

  if(isRotated){
    playerEl.style.width  = '100vh';
    playerEl.style.height = '100vw';
    playerEl.style.objectFit = 'cover';
    playerEl.style.transform = 'rotate(90deg)';
    playerEl.style.transformOrigin = 'center center';
    return;
  }

  if(isLandscape){
    playerEl.style.width='100vw';
    playerEl.style.height='100vh';
    playerEl.style.objectFit='cover';
    document.body.style.overflow='hidden';
  } else {
    playerEl.style.width='100%';
    playerEl.style.height='auto';
    playerEl.style.objectFit='contain';
    document.body.style.overflow='';
  }
  playerEl.style.transform='none';
  playerEl.style.transformOrigin='center center';
}

// ================== Ø§Ù„Ø³Ù„Ø§ÙŠØ¯Ø± ==================

const slidesByKind = {
  home:   [],
  live:   [],
  movies: [],
  series: []
};

const heroSliders = {};

function shuffle(arr){
  for(let i=arr.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    const tmp=arr[i]; arr[i]=arr[j]; arr[j]=tmp;
  }
}

function pickRandom(list, max){
  if(!list || !list.length) return [];
  const copy = list.slice();
  shuffle(copy);
  return copy.slice(0, max);
}

function buildSlidesFromCache(){
  slidesByKind.movies = pickRandom(cache.movies, 10);
  slidesByKind.series = pickRandom(cache.series, 10);
  slidesByKind.live   = pickRandom(cache.live,   10);

  let mix = [];
  if(cache.live && cache.live.length)   mix = mix.concat(cache.live);
  if(cache.movies && cache.movies.length) mix = mix.concat(cache.movies);
  if(cache.series && cache.series.length) mix = mix.concat(cache.series);

  slidesByKind.home = pickRandom(mix, 10);
}

function renderSlider(kind, trackId, dotsId){
  const track = document.getElementById(trackId);
  const dots  = document.getElementById(dotsId);
  if(!track || !dots) return;

  track.innerHTML = '';
  dots.innerHTML  = '';

  const items = slidesByKind[kind] || [];
  if(!items.length){
    const slide = document.createElement('div');
    slide.className='hero-slide';
    const bg = document.createElement('div');
    bg.className='hero-bg';
    bg.style.backgroundImage = `url('https://via.placeholder.com/1280x720?text=No+Content')`;
    const ov = document.createElement('div');
    ov.className='hero-overlay';
    const info = document.createElement('div');
    info.className='hero-info';
    info.innerHTML = `
      <div class="hero-type">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø­ØªÙˆÙ‰</div>
      <div class="hero-title">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ± Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹</div>
      <div class="hero-meta">Ø³ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ù„Ø§ÙŠØ¯Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ ØªÙˆÙØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±.</div>
    `;
    slide.appendChild(bg);
    slide.appendChild(ov);
    slide.appendChild(info);
    track.appendChild(slide);
    return;
  }

  items.forEach((it, idx)=>{
    const slide = document.createElement('div');
    slide.className='hero-slide';

    const imgSrc =
      it.stream_icon || it.icon || it.tv_series_thumb || it.cover || it.poster ||
      'https://via.placeholder.com/1280x720?text=No+Image';

    const bg = document.createElement('div');
    bg.className='hero-bg';
    bg.style.backgroundImage = `url('${imgSrc}')`;

    const ov = document.createElement('div');
    ov.className='hero-overlay';

    const info = document.createElement('div');
    info.className='hero-info';

    let typeLabel = '';
    const t = guessSectionType(it);
    if(t === 'series') typeLabel = 'Ù…Ø³Ù„Ø³Ù„';
    else if(t === 'vod') typeLabel = 'ÙÙŠÙ„Ù… / ÙÙŠØ¯ÙŠÙˆ';
    else if(t === 'live') typeLabel = 'Ù‚Ù†Ø§Ø© Ø¨Ø« Ù…Ø¨Ø§Ø´Ø±';
    else typeLabel = 'Ù…Ø­ØªÙˆÙ‰';

    const title = it.name || it.title || it.channel || 'Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†';
    const catName = it.category_name || it.category || '';

    info.innerHTML = `
      <div class="hero-type">${typeLabel}</div>
      <div class="hero-title">${title}</div>
      <div class="hero-meta">${catName || ''}</div>
    `;

    slide.appendChild(bg);
    slide.appendChild(ov);
    slide.appendChild(info);

    slide.addEventListener('click', ()=>{
      if(guessSectionType(it)==='series') openSeries(it);
      else openPlayerOrFallback(it, false);
    });

    track.appendChild(slide);

    const dot = document.createElement('div');
    dot.className='hero-dot' + (idx===0 ? ' active' : '');
    dot.addEventListener('click', ()=>{
      const s = heroSliders[kind];
      if(!s) return;
      s.index = idx;
      updateHeroSlider(kind);
      startHeroAuto(kind);
    });
    dots.appendChild(dot);
  });

  heroSliders[kind] = {
    index:0,
    track,
    dots,
    total: items.length,
    timer:null
  };

  updateHeroSlider(kind);
  startHeroAuto(kind);
}

function updateHeroSlider(kind){
  const s = heroSliders[kind];
  if(!s || !s.total) return;
  if(s.index < 0) s.index = s.total-1;
  if(s.index >= s.total) s.index = 0;

  s.track.style.transform = `translateX(-${s.index * 100}%)`;

  const dotEls = s.dots.querySelectorAll('.hero-dot');
  dotEls.forEach((d,i)=> d.classList.toggle('active', i === s.index));
}

function startHeroAuto(kind){
  const s = heroSliders[kind];
  if(!s || !s.total) return;
  if(s.timer) clearInterval(s.timer);
  s.timer = setInterval(()=>{
    s.index++;
    updateHeroSlider(kind);
  }, 5000);
}

function renderAllSliders(){
  renderSlider('home',   'homeSliderTrack',   'homeSliderDots');
  renderSlider('live',   'liveSliderTrack',   'liveSliderDots');
  renderSlider('movies', 'moviesSliderTrack', 'moviesSliderDots');
  renderSlider('series', 'seriesSliderTrack', 'seriesSliderDots');
}

// ================== Ø´Ø±ÙŠØ· Ø§Ù„ØªØ¨ÙˆÙŠØ¨ + Ø§Ù„ØµÙØ­Ø§Øª ==================

const pages = {
  home:   document.getElementById('homePage'),
  live:   document.getElementById('livePage'),
  movies: document.getElementById('moviesPage'),
  series: document.getElementById('seriesMainPage')
};

function showPage(key){
  Object.keys(pages).forEach(k=>{
    if(!pages[k]) return;
    pages[k].style.display = (k === key ? 'block' : 'none');
  });
  window.scrollTo({top:0, behavior:'instant'});
}

document.getElementById('navInner').addEventListener('click', (ev)=>{
  const tab = ev.target.closest('.tab'); 
  if(!tab) return;

  Array.from(document.querySelectorAll('.tab')).forEach(t=>t.classList.remove('active'));
  tab.classList.add('active');

  const target = tab.dataset.target || 'home';
  showPage(target);
});

// "Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø²ÙŠØ¯" ÙÙŠ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
document.getElementById('sectionsContainer').addEventListener('click',(ev)=>{
  const more = ev.target.closest('.more');
  if(!more) return;
  const type = more.dataset.type;
  if(type === 'movies')      showPage('movies');
  else if(type === 'series') showPage('series');
  else if(type === 'live')   showPage('live');
  else                       showPage('home');

  const tab = document.querySelector(`.tab[data-target="${type}"]`);
  if(tab){
    Array.from(document.querySelectorAll('.tab')).forEach(t=>t.classList.remove('active'));
    tab.classList.add('active');
  }
});

// ØªØ´ØºÙŠÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
document.addEventListener('DOMContentLoaded', () => {
  const app = document.getElementById('appUI');
  if(app) app.style.display = 'block';
  showPage('home');
  loadAllSections(false).catch(e => console.error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…', e));
});

window.addEventListener('resize', ()=>{ if(playerPage.style.display==='flex') adjustPlayerForOrientation(); });
window.addEventListener('orientationchange', ()=>{ if(playerPage.style.display==='flex') adjustPlayerForOrientation(); });
</script>
</body>
</html>
