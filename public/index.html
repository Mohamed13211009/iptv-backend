<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ø§Ù„Ø£Ø³Ø·ÙˆØ±Ø© TV â€” IPTV (Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©)</title>

<style>
:root{
--bg:#020617;
--bg2:#020617;
--card:#050b1e;
--muted:rgba(255,255,255,0.7);
--accent:#6ee7ff;
--accent2:#a855f7;
}

*{box-sizing:border-box}
html,body{height:100%}

body{
margin:0;
font-family:system-ui,Roboto,Arial;
background:
radial-gradient(circle at top, #1d2345 0, #020617 40%, #000 100%),
linear-gradient(180deg,#020617,#000);
color:#fff;
direction:rtl;
}

.container{
max-width:980px;
margin:12px auto;
padding:0 12px 90px;
}


.top-bar{
display:flex;
justify-content:space-between;
align-items:center;
margin:4px 0 8px;
}
.top-title{
font-size:18px;
font-weight:800;
}
.search-box{
display:flex;
align-items:center;
gap:4px;
}
.search-input{
background:#020617;
border:1px solid rgba(148,163,184,0.8);
color:#e5e7eb;
padding:6px 8px;
border-radius:0;
font-size:13px;
width:160px;
}
.search-input::placeholder{
color:rgba(148,163,184,0.8);
}
.search-btn{
background:#0f172a;
border:1px solid rgba(148,163,184,0.9);
color:#e5e7eb;
padding:6px 9px;
border-radius:0;
cursor:pointer;
font-size:14px;
}


.carousel{
width:100%;
height:230px;
border-radius:0;
overflow-x:auto;
overflow-y:hidden;
background:#000;
margin:8px 0 4px;
scroll-snap-type:x mandatory;
}
.slidesOuter{
display:flex;
width:max-content;
height:100%;
}
.slideItem{
flex:0 0 100%;
max-width:100%;
height:100%;
border-radius:0;
background-size:cover;
background-position:center center;
background-repeat:no-repeat;
display:flex;
flex-direction:column;
justify-content:flex-end;
padding:12px;
color:#fff;
font-weight:800;
text-shadow:0 2px 8px rgba(0,0,0,0.8);
cursor:pointer;
scroll-snap-align:center;
position:relative;
}
.slideItem::before{
content:"";
position:absolute;
inset:0;
background:linear-gradient(180deg,rgba(0,0,0,0.15),rgba(0,0,0,0.8));
}
.slideTitle,
.slideSubtitle{
position:relative;
display:block;
}
.slideTitle{
font-size:18px;
margin-bottom:4px;
background:rgba(0,0,0,0.75);
padding:6px 10px;
border-radius:0;
}
.slideSubtitle{
font-size:13px;
color:var(--muted);
background:rgba(0,0,0,0.8);
padding:4px 10px;
border-radius:0;
margin-top:2px;
}

.slider-dots{
position:relative;
margin-top:6px;
display:flex;
justify-content:center;
gap:6px;
}
.slider-dot{
width:10px;
height:4px;
border-radius:0;
background:rgba(148,163,184,0.5);
transition:all .15s ease;
}
.slider-dot.active{
background:#ffffff;
width:22px;
}


.section{margin:18px 0}
.hdr{
display:flex;
align-items:center;
justify-content:space-between;
margin-bottom:10px;
}
.hdr .title{
font-weight:800;
font-size:15px;
}
.hdr .more{
color:var(--muted);
font-weight:700;
cursor:pointer;
font-size:13px;
padding:4px 10px;
border-radius:0;
background:rgba(15,23,42,0.8);
border:1px solid rgba(148,163,184,0.6);
}

.row-scroll{
display:flex;
gap:10px;
overflow-x:auto;
padding-bottom:6px;
}

.item{
flex:0 0 auto;
width:110px;
height:178px;
display:flex;
cursor:pointer;
border-radius:0;
overflow:hidden;
background:#000;
}

.thumb{
width:100%;
height:100%;
border-radius:0;
overflow:hidden;
background:#020617;
display:flex;
align-items:center;
justify-content:center;
border:none;
}
.thumb.live-thumb{
height:100px;
}
.thumb img{
width:100%;
height:100%;
object-fit:cover;
display:block;
}

.muted{color:var(--muted);font-size:14px}


.loader-wrap{
display:flex;
justify-content:center;
align-items:center;
padding:60px 0;
flex-direction:column;
}

.loader-title{
margin-top:12px;
font-size:20px;
font-weight:700;
letter-spacing:.12em;
color:#e5e7eb;
text-transform:uppercase;
text-align:center;
}
.loader{
width:40px;
height:40px;
border-radius:50%;
border:4px solid rgba(148,163,184,0.3);
border-top-color:#22d3ee;
border-right-color:#a855f7;
animation:spin .8s linear infinite;
}
@keyframes spin{
to{transform:rotate(360deg);}
}


#playerPage{
display:none;
position:fixed;
inset:0;
z-index:300;
background:#000;
align-items:center;
justify-content:center;
}
#player{
width:100%;
max-height:100vh;
min-height:220px;
background:#000;
object-fit:contain;
}
.player-top{
position:absolute;
top:10px;
left:12px;
right:12px;
display:flex;
justify-content:space-between;
align-items:center;
z-index:310;
}
.player-btn{
background:rgba(0,0,0,0.8);
color:#e5e7eb;
border:none;
padding:8px 14px;
border-radius:0;
font-weight:700;
font-size:13px;
display:flex;
align-items:center;
gap:6px;
cursor:pointer;
border:1px solid rgba(148,163,184,0.8);
}
.player-top-right{
display:flex;
gap:8px;
align-items:center;
}

/* ======= bottom nav ======= */
.bottom-nav{
position:fixed;
left:0;right:0;bottom:0;
height:70px;
background:linear-gradient(180deg,transparent,rgba(0,0,0,0.95));
display:flex;
align-items:center;
justify-content:center;
z-index:320;
}
.nav-inner{
width:100%;
max-width:980px;
display:flex;
justify-content:space-around;
align-items:center;
padding:8px;
gap:6px;
}
.tab{
flex:1;
display:flex;
flex-direction:column;
align-items:center;
gap:4px;
cursor:pointer;
padding:6px 4px;
border-radius:0;
transition:background .2s ease, transform .1s ease;
}
.tabIcon{
width:28px;
height:28px;
border-radius:0;
border:1px solid rgba(148,163,184,0.7);
display:flex;
align-items:center;
justify-content:center;
font-size:15px;
background:#020617;
}
.label{
font-size:13px;
color:var(--muted);
}
.tab.active{
background:rgba(15,23,42,0.9);
transform:translateY(-2px);
}
.tab.active .tabIcon{
border-color:#22d3ee;
background:#000;
}
.tab.active .label{
color:#fff;
font-weight:800;
}


#seriesPage{
display:none;
position:fixed;
inset:0;
background:#020617;
z-index:400;
overflow-y:auto;
padding:18px;
}
#seriesTitleHeader{
text-align:center;
margin:0 0 10px 0;
font-size:22px;
font-weight:800;
}
.seasonsBar{
display:flex;
gap:8px;
margin:6px 0 4px;
overflow-x:auto;
padding-bottom:4px;
}
.seasonChip{
flex:0 0 auto;
border-radius:0;
border:1px solid rgba(148,163,184,0.6);
padding:6px 12px;
font-size:13px;
color:var(--muted);
cursor:pointer;
white-space:nowrap;
background:rgba(15,23,42,0.9);
}
.seasonChip.active{
background:#fff;
color:#0f172a;
border-color:#fff;
font-weight:700;
}
.episodesGrid{
display:grid;
grid-template-columns:repeat(3,110px);
justify-content:center;
gap:12px;
margin-top:10px;
}
.episodeItem{
width:110px;
background:#000;
border-radius:0;
overflow:hidden;
cursor:pointer;
display:flex;
flex-direction:column;
}
.episodeThumb{
width:110px;
height:180px;
object-fit:cover;
display:block;
}
.episodeMeta{padding:6px 6px 8px}
.episodeTitle{
font-size:12px;
font-weight:700;
text-align:center;
}


#imageViewer{
display:none;
position:fixed;
inset:0;
z-index:350;
background:#000;
align-items:center;
justify-content:center;
}
#imageViewEl{
max-width:100%;
max-height:100%;
object-fit:contain;
}

#morePage{
position:fixed;
inset:0;
background:#020617;
z-index:380;
overflow-y:auto;
padding:18px 12px 90px;
}
.morePage-header{
display:flex;
justify-content:space-between;
align-items:center;
margin-bottom:8px;
gap:8px;
}
.morePage-title{
font-size:18px;
font-weight:800;
}
.morePage-searchInput{
background:#020617;
border:1px solid rgba(148,163,184,0.8);
color:#e5e7eb;
padding:6px 8px;
border-radius:0;
font-size:13px;
flex:1;
min-width:0;
}
.morePage-grid{
display:grid;
grid-template-columns:repeat(3,110px);
justify-content:center;
gap:12px;
margin-top:10px;
}
.morePage-card{
width:110px;
background:#000;
border-radius:0;
overflow:hidden;
cursor:pointer;
display:flex;
}
.morePage-thumb{
width:110px;
height:178px;
background:#020617;
}
.morePage-thumb img{
width:100%;
height:100%;
object-fit:cover;
display:block;
}

@media(max-width:520px){
.slideItem{flex:0 0 100%;max-width:100%}
}






/* ======= overlay pages (movies / series / live) ======= */
.page-overlay{
position:fixed;
inset:0;
background:rgba(0,0,0,0.9);
display:none;
align-items:center;
justify-content:center;
z-index:500;
}
.page-overlay-inner{
width:100%;
height:100%;
max-width:980px;
background:#000;
display:flex;
flex-direction:column;
}
.page-overlay-header{
display:flex;
align-items:center;
justify-content:space-between;
padding:10px 12px;
background:linear-gradient(180deg,rgba(15,23,42,0.98),rgba(15,23,42,0.95));
border-bottom:1px solid rgba(148,163,184,0.4);
}
.page-overlay-title{
color:#fff;
font-size:16px;
font-weight:600;
}
.page-overlay-close{
background:none;
border:0;
color:#fff;
font-size:22px;
cursor:pointer;
padding:2px 8px;
line-height:1;
}
.page-overlay-frame{
flex:1;
border:0;
width:100%;
}

.page-overlay-content{
flex:1;
overflow:auto;
padding:12px;
}


#appUI{display:none;}

</style>
</head>
<body>


<!-- Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ -->
<div id="app-content-wrapper">

<main class="container">
<div id="appUI">

<!-- ØªÙˆØ¨ Ø¨Ø§Ø±: Ø¹Ù†ÙˆØ§Ù† + Ø¨Ø­Ø« -->
<div class="top-bar">
<div class="top-title">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
<div class="search-box">
<input id="searchInput" class="search-input" type="text" placeholder="Ø§Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ø­ØªÙˆÙ‰..." />
<button id="searchBtn" class="search-btn">ğŸ”</button>
</div>
</div>

<div class="carousel" id="carousel">
<div class="slidesOuter" id="slidesOuter"></div>
</div>
<div class="slider-dots" id="sliderDots"></div>

<div id="sectionsContainer"></div>

<!-- ØµÙØ­Ø© ÙÙˆÙ‚ Ø§Ù„ØµÙØ­Ø© (Ø£ÙÙ„Ø§Ù… / Ù…Ø³Ù„Ø³Ù„Ø§Øª / Ø¨Ø« Ù…Ø¨Ø§Ø´Ø±) -->
<div id="pageOverlay" class="page-overlay">
<div class="page-overlay-inner">
<header class="page-overlay-header">
<div id="pageOverlayTitle" class="page-overlay-title">Ø§Ù„Ù…Ø­ØªÙˆÙ‰</div>
<button id="closePageOverlay" class="page-overlay-close">&times;</button>
</header>
<div id="pageOverlayContent" class="page-overlay-content"></div>
</div>
</div>

</div>
</main>

<!-- ØµÙØ­Ø© Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø²ÙŠØ¯ Ù„Ù„Ø£ÙÙ„Ø§Ù… ÙˆØ§Ù„Ù…Ø³Ù„Ø³Ù„Ø§Øª -->
<div id="morePage" style="display:none;">
<main class="container">
<div class="morePage-header">
<button onclick="closeMorePage()" class="player-btn">â¬…ï¸ Ø±Ø¬ÙˆØ¹</button>
<div class="morePage-title" id="moreTitle"></div>
<input id="moreSearchInput" class="morePage-searchInput" type="text" placeholder="Ø¨Ø­Ø« Ø¯Ø§Ø®Ù„ Ù‡Ø°Ù‡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©..." />
</div>
<div id="moreGrid" class="morePage-grid"></div>
</main>
</div>

<!-- ØµÙØ­Ø© Ø§Ù„Ø­Ù„Ù‚Ø§Øª -->
<div id="seriesPage">
<div style="margin-bottom:8px;display:flex;justify-content:flex-end">
<button onclick="closeSeries()" class="player-btn">â¬…ï¸ Ø±Ø¬ÙˆØ¹</button>
</div>
<h2 id="seriesTitleHeader"></h2>
<div class="content" id="seriesContent"></div>
</div>

<!-- Ø§Ù„Ù…Ø´ØºÙ„ -->
<div id="playerPage">
<div class="player-top">
<button onclick="closePlayer()" class="player-btn">â¬…ï¸ Ø±Ø¬ÙˆØ¹</button>
<div class="player-top-right">
<button class="player-btn" onclick="toggleRotate()">ØªØ¯ÙˆÙŠØ± ğŸ”„</button>
</div>
</div>
<video id="player" controls playsinline></video>
<div style="margin-top:8px; display:flex; justify-content:flex-end; gap:8px;">
<button id="btn-fullscreen" style="background:#222;border-radius:8px;padding:6px 12px;border:1px solid #555;color:#fff;font-size:13px;">
â›¶ ØªÙƒØ¨ÙŠØ± Ø§Ù„Ù…Ø´ØºÙ„
</button>
</div>

</div>

<!-- Ø§Ø³ØªØ¹Ø±Ø§Ø¶ Ø§Ù„ØµÙˆØ± -->
<div id="imageViewer">
<div class="player-top">
<button onclick="closeImageViewer()" class="player-btn">â¬…ï¸ Ø±Ø¬ÙˆØ¹</button>
</div>
<img id="imageViewEl" src="" alt="">
</div>

<!-- Ø´Ø±ÙŠØ· Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… -->
<div class="bottom-nav">
<div class="nav-inner" id="navInner">
<div class="tab active" data-view="home">
<div class="tabIcon">ğŸ </div>
<div class="label">Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</div>
</div>
<div class="tab" data-view="movies">
<div class="tabIcon">ğŸ¬</div>
<div class="label">Ø§Ù„Ø£ÙÙ„Ø§Ù…</div>
</div>
<div class="tab" data-view="series">
<div class="tabIcon">ğŸ“º</div>
<div class="label">Ø§Ù„Ù…Ø³Ù„Ø³Ù„Ø§Øª</div>
</div>
<div class="tab" data-view="live">
<div class="tabIcon">ğŸ“¡</div>
<div class="label">Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</div>
</div>
</div>
</div>

</div><!-- /app-content-wrapper -->

<script src="https://cdn.jsdelivr.net/npm/hls.js@1"></script>
<script>


const XOR_KEY_SERVER = 19;
const XOR_KEY_USER   = 23;
const XOR_KEY_PASS   = 31;

const ENCODED_SERVER = []; // moved to backend
function xorDecode(arr, key){
return String.fromCharCode(...arr.map(c => c ^ key));
}
function getServerUrl(){
const b64 = xorDecode(ENCODED_SERVER, XOR_KEY_SERVER);
return atob(b64);
}


const ENCODED_USER = []; // moved to backend
function getUserName(){
const b64 = xorDecode(ENCODED_USER, XOR_KEY_USER);
return atob(b64);
}


const ENCODED_PASS = []; // moved to backend
function getUserPassword(){
const b64 = xorDecode(ENCODED_PASS, XOR_KEY_PASS);
return atob(b64);
}

let sessionUser = { server: location.origin, user: '', pass: '' }; // credentials moved to backend proxy

let cache = {
movies:  [],
vodCats: []
};

let recentList = [];
let searchResults = [];

let searchDataLoaded = false;
let searchAll = { movies:[], series:[], live:[] };

function cacheKey(id){ return 'iptv_cache_' + id; }
const RECENT_KEY = 'iptv_recent_items';

function saveCache(id,data){
try{
localStorage.setItem(cacheKey(id), JSON.stringify({ts:Date.now(),data}));
}catch(e){}
}
function loadCache(id){
try{
const raw = localStorage.getItem(cacheKey(id));
if(!raw) return null;
const o=JSON.parse(raw);
if(!o || !o.data) return null;
const age = Date.now() - (o.ts || 0);
if(age > 1000*60*60*24*3) return null;
return o.data;
}catch(e){return null}
}

function loadRecent(){
try{
const raw = localStorage.getItem(RECENT_KEY);
if(!raw) return [];
const arr = JSON.parse(raw);
return Array.isArray(arr) ? arr : [];
}catch(e){return []}
}
function saveRecent(){
try{
localStorage.setItem(RECENT_KEY, JSON.stringify(recentList));
}catch(e){}
}
function addToRecent(item){
const id =
item.stream_id ||
item.movie_id ||
item.id ||
item.stream ||
(item.name || item.title || '');

if(!id) return;

const poster = item.stream_icon||item.icon||item.cover||item.poster||'';

const rec = {
id,
name: item.name || item.title || 'Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†',
stream_id: item.stream_id || item.movie_id || item.id || item.stream || null,
poster,
savedAt: Date.now()
};

recentList = recentList.filter(r => r.id !== rec.id);
recentList.unshift(rec);
if(recentList.length > 20) recentList.length = 20;

saveRecent();
}


function getItemKey(it){
return (
it.stream_id ||
it.series_id ||
it.movie_id ||
it.id ||
it.channel_id ||
it.epg_id ||
(it.name && it.stream_type ? it.name + '_' + it.stream_type : it.name || null)
);
}
function mergeLists(oldList, newList){
const result = [];
const seen = new Set();
(newList || []).forEach(it=>{
const k = getItemKey(it);
if(!k || seen.has(k)) return;
seen.add(k);
result.push(it);
});
(oldList || []).forEach(it=>{
const k = getItemKey(it);
if(!k || seen.has(k)) return;
seen.add(k);
result.push(it);
});
return result;
}

function extractArray(resp){
if(Array.isArray(resp)) return resp;
if(resp && typeof resp === 'object'){
const keys=['data','items','result','streams','response','rows','videos','channels','list','categories'];
for(const k of keys) if(Array.isArray(resp[k])) return resp[k];
for(const k in resp) if(Array.isArray(resp[k])) return resp[k];
}
return null;
}
async function fetchJson(url, opts={}, timeout=12000){
const controller = new AbortController();
const id = setTimeout(()=>controller.abort(), timeout);
try{
const res = await fetch(url, {...opts, signal:controller.signal, cache:'no-store'});
clearTimeout(id);
if(!res.ok) throw new Error('HTTP ' + res.status);
return await res.json();
}catch(e){ clearTimeout(id); throw e; }
}
async function fetchSection(server,user,pass,action){
  // Credentials are NOT used in the browser anymore.
  // Backend proxy injects username/password securely.
  const base = (server || location.origin).replace(/\/$/,'');
  const url  = `${base}/api/player_api?action=${encodeURIComponent(action)}`;
  const json = await fetchJson(url);
  const arr  = extractArray(json);
  if(arr === null) throw new Error('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØµÙÙˆÙØ© ÙÙŠ Ø±Ø¯ Ø§Ù„Ø³ÙŠØ±ÙØ±');
  return arr;
}


function getAddedTimestamp(it){
const v = it.added || it.created_at || it.last_modified || null;
if(!v) return 0;
const n = parseInt(v,10);
if(!isNaN(n) && n > 100000000) return n;
const d = new Date(v).getTime();
return isNaN(d) ? 0 : Math.floor(d/1000);
}


function buildLatestItems(){
const list = (cache.movies || []).slice();
list.sort((a,b)=> getAddedTimestamp(b) - getAddedTimestamp(a));
return list.slice(0,20);
}


async function loadAllSections(){
const container = document.getElementById('sectionsContainer');
container.innerHTML = `
<div class="loader-wrap">
<div class="loader"></div>
<div class="loader-title">MY TV</div>
</div>
`;

cache.movies  = loadCache('movies')  || [];
cache.vodCats = loadCache('vodCats') || [];
recentList    = loadRecent();

const hadCache = cache.movies.length && cache.vodCats.length;

if(hadCache){
renderCurrentView();
// Ù„Ø§ Ù†ÙØ¹ÙŠØ¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± Ø·Ø§Ù„Ù…Ø§ Ø§Ù„ÙƒØ§Ø´ ØµØ§Ù„Ø­ (Ø­ØªÙ‰ 3 Ø£ÙŠØ§Ù…)
return;
}

if(!sessionUser){
if(!hadCache){
container.innerHTML = '<div class="muted" style="padding:40px 0;text-align:center;">Ù„Ù… ÙŠØªÙ… Ø¥Ø¹Ø¯Ø§Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„</div>';
}
return;
}

try{
const [moviesFresh, vodCatsFresh] = await Promise.all([
fetchSection(sessionUser.server, sessionUser.user, sessionUser.pass, 'get_vod_streams'),
fetchSection(sessionUser.server, sessionUser.user, sessionUser.pass, 'get_vod_categories')
]);

cache.movies = mergeLists(cache.movies, moviesFresh || []);
if(vodCatsFresh && vodCatsFresh.length){
cache.vodCats = vodCatsFresh;
}

saveCache('movies',  cache.movies);
saveCache('vodCats', cache.vodCats);

renderCurrentView();
}catch(e){
console.warn('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ÙÙ„Ø§Ù… Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±', e);
if(!hadCache){
container.innerHTML = '<div class="muted" style="padding:40px 0;text-align:center;">ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙÙ„Ø§Ù… Ø­Ø§Ù„ÙŠØ§Ù‹</div>';
}
}
}



function renderRowElement(rowEl, items){
rowEl.innerHTML = '';
if(!items || !items.length){
rowEl.innerHTML = '<div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</div>';
return;
}
items.slice(0,13).forEach(it=> rowEl.appendChild(makeItem(it)));
}

function guessSectionType(item){
if(item.tv_series_id || item.series_id || item.vod_type==='series' ||
item.episode_id || item.season ||
(item.category && /series|Ù…Ø³Ù„Ø³Ù„/i.test(item.category))) {
return 'series';
}
if(item.stream_type === 'live' || item.category_name === 'Live'){
return 'live';
}
return 'vod';
}

function makeItem(obj){
const it = document.createElement('div');
const type = guessSectionType(obj);
const isLive = (type === 'live');
const isSeries = (type === 'series');

it.className='item';

const thumb = document.createElement('div');
thumb.className = 'thumb' + (isLive ? ' live-thumb' : '');

const img = document.createElement('img');
img.loading='lazy';
img.src = obj.stream_icon||obj.icon||obj.tv_series_thumb||obj.cover||obj.poster||'https://via.placeholder.com/320x180?text=No+Image';
img.onerror = ()=>{ img.src='https://via.placeholder.com/320x180?text=No+Image'; };
thumb.appendChild(img);

it.appendChild(thumb);

it.addEventListener('click', ()=>{
if(isSeries) openSeries(obj);
else openPlayerOrFallback(obj,false);
});

return it;
}


function normalizeCategoryName(name){
const raw = (name || '').toString();
let s = raw.replace(/[0-9Ù -Ù©]+/g,' ');
s = s.replace(/[-â€“â€”Ù€_,ØŒ]+/g,' ');
s = s.replace(/\s{2,}/g,' ').trim();
return s || raw || 'ØªØµÙ†ÙŠÙ';
}

function buildCategoriesForMovies(){
const items = cache.movies || [];
const cats  = cache.vodCats || [];
const groups = {};
const catIdToKey = {};

cats.forEach(cat=>{
const rawName = cat.category_name || cat.category_name_ar || cat.name || 'ØªØµÙ†ÙŠÙ';
const normName = normalizeCategoryName(rawName);
const key = normName;
const id = String(cat.category_id || cat.category || cat.id || key);
if(!id) return;
catIdToKey[id] = key;
if(!groups[key]){
groups[key] = { id:key, name:normName, items:[] };
}
});

items.forEach(it=>{
const id = String(it.category_id || it.category || '');
const key = catIdToKey[id];
if(!key || !groups[key]) return;
groups[key].items.push(it);
});

return Object.values(groups).filter(g => g.items && g.items.length);
}


function renderRecentSection(container){
if(!recentList || !recentList.length) return;

const sec = document.createElement('section');
sec.className = 'section';

sec.innerHTML = `
<div class="hdr">
<div class="title">Ø¢Ø®Ø± Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø§Øª</div>
<div class="more" id="clearRecentBtn">Ù…Ø³Ø­ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</div>
</div>
<div class="row-scroll" id="recentRow"></div>
`;
container.appendChild(sec);

const row = sec.querySelector('#recentRow');
row.innerHTML = '';

recentList.slice(0,13).forEach(rec=>{
const it = document.createElement('div');
it.className='item';

const thumb = document.createElement('div');
thumb.className='thumb';

const img = document.createElement('img');
img.loading='lazy';
img.src = rec.poster || 'https://via.placeholder.com/320x180?text=No+Image';
img.onerror = ()=>{ img.src='https://via.placeholder.com/320x180?text=No+Image'; };
thumb.appendChild(img);

it.appendChild(thumb);

it.addEventListener('click', ()=>{
const fakeItem = {
stream_id: rec.stream_id || rec.id,
name: rec.name,
stream_icon: rec.poster
};
openPlayerOrFallback(fakeItem,false);
});

row.appendChild(it);
});

const clearBtn = sec.querySelector('#clearRecentBtn');
clearBtn.addEventListener('click', ()=>{
if(confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ø³Ø­ Ù‚Ø§Ø¦Ù…Ø© Ø¢Ø®Ø± Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø§ØªØŸ')){
recentList = [];
saveRecent();
sec.remove();
}
});
}


function renderLatestSection(container){
const latest = buildLatestItems();
if(!latest || !latest.length) return;

const sec = document.createElement('section');
sec.className = 'section';

sec.innerHTML = `
<div class="hdr">
<div class="title">Ø¢Ø®Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ§Øª</div>
<div class="more" data-go="go:latest">Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø²ÙŠØ¯</div>
</div>
<div class="row-scroll" id="latestRow"></div>
`;
container.appendChild(sec);

const row = sec.querySelector('#latestRow');
renderRowElement(row, latest);
}


function renderSearchSection(container){
const sec = document.createElement('section');
sec.className = 'section';

sec.innerHTML = `
<div class="hdr">
<div class="title">Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«</div>
<div class="more" id="cancelSearchBtn">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¨Ø­Ø«</div>
</div>
<div class="row-scroll" id="searchRow"></div>
`;
container.appendChild(sec);

const row = sec.querySelector('#searchRow');

if(!searchResults.length){
row.innerHTML = '<div class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø©</div>';
}else{
searchResults.slice(0,40).forEach(it=> row.appendChild(makeItem(it)));
}

sec.querySelector('#cancelSearchBtn').onclick = ()=>{
searchResults = [];
const inp = document.getElementById('searchInput');
if(inp) inp.value='';
renderCurrentView();
};
}


function renderMovieCategories(container){
const cats = buildCategoriesForMovies();

if(!cats.length){
const emptySec = document.createElement('section');
emptySec.className='section';
emptySec.innerHTML = '<div class="muted" style="padding:20px 0;text-align:center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ù‚Ø³Ø§Ù… Ù…ØªØ§Ø­Ø© Ù„Ù„Ø£ÙÙ„Ø§Ù… Ø­Ø§Ù„ÙŠØ§Ù‹</div>';
container.appendChild(emptySec);
return;
}

cats.forEach(cat=>{
const sec = document.createElement('section');
sec.className = 'section category-section';
const rowId = `cat-movies-${cat.id}-row`;
const goCode = `go:cat_${cat.id}`;
sec.innerHTML = `
<div class="hdr">
<div class="title">${cat.name}</div>
<div class="more" data-go="${goCode}">Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø²ÙŠØ¯</div>
</div>
<div class="row-scroll" id="${rowId}"></div>
`;
container.appendChild(sec);

const row = sec.querySelector('#'+CSS.escape(rowId));
renderRowElement(row, cat.items);
});

function renderMoreGrid(list){
const grid = document.getElementById('moreGrid');
if(!grid) return;
grid.innerHTML = '';
if(!list || !list.length){
const empty = document.createElement('div');
empty.className = 'morePage-empty';
empty.textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ± Ù…Ø·Ø§Ø¨Ù‚Ø©';
grid.appendChild(empty);
return;
}
list.forEach(it=>{
const card = document.createElement('div');
card.className = 'morePage-card';

const thumb = document.createElement('div');
thumb.className = 'morePage-thumb';

const img = document.createElement('img');
img.loading = 'lazy';
img.src = it.stream_icon || it.icon || it.tv_series_thumb || it.cover || it.poster || 'https://via.placeholder.com/320x180?text=No+Image';
img.onerror = ()=>{ img.src = 'https://via.placeholder.com/320x180?text=No+Image'; };

thumb.appendChild(img);
card.appendChild(thumb);

card.addEventListener('click', ()=>{
const t = guessSectionType(it);
if(t === 'series'){
openSeries(it);
}else{
openPlayerOrFallback(it, false);
}
});

grid.appendChild(card);
});
}

function openMorePage(title, items){
const page = document.getElementById('morePage');
const titleEl = document.getElementById('moreTitle');
const searchInput = document.getElementById('moreSearchInput');
if(!page || !titleEl) return;

currentMoreItems = Array.isArray(items) ? items.slice() : [];
titleEl.textContent = title || 'Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©';

page.style.display = 'block';

renderMoreGrid(currentMoreItems);

if(searchInput){
searchInput.value = '';
searchInput.oninput = ()=>{
const q = searchInput.value.trim().toLowerCase();
if(!q){
renderMoreGrid(currentMoreItems);
return;
}
const filtered = currentMoreItems.filter(it=>{
const name = (it.name || it.title || '').toString().toLowerCase();
return name.includes(q);
});
renderMoreGrid(filtered);
};
}
}

function closeMorePage(){
const page = document.getElementById('morePage');
if(page) page.style.display = 'none';
}
}


function getExtFromItem(item){
let ext = (item.container_extension || item.ext || '').toString().toLowerCase().replace(/^\./,'');
if(!ext && item.url){
try{
const u = new URL(item.url, window.location.href);
const m = u.pathname.match(/\.([^.\/]+)$/);
if(m) ext = m[1].toLowerCase();
}catch(e){}
}
return ext;
}
function getExtFromUrl(url, fallback){
try{
const u = new URL(url, window.location.href);
const m = u.pathname.match(/\.([^.\/]+)$/);
if(m) return m[1].toLowerCase();
}catch(e){}
return (fallback||'').toLowerCase().replace(/^\./,'');
}
function buildCandidateUrls(item){
  if(!sessionUser) return [];
  const base = sessionUser.server.replace(/\/$/,'');
  const type = guessSectionType(item);
  const ext  = getExtFromItem(item) || (type === 'live' ? 'm3u8' : 'mp4');

  const sid =
    item.stream_id ||
    item.movie_id ||
    item.id ||
    item.series_id ||
    item.channel ||
    item.stream;

  const urls = [];
  const direct = item.url || item.file || item.play_url || item.stream_url;
  if(direct) urls.push(direct);
  if(!sid) return [...new Set(urls)];

  // Stream through backend proxy so username/password never appear in the client.
  const add = (u)=>{ if(u && !urls.includes(u)) urls.push(u); };
  add(`${base}/api/stream?type=${encodeURIComponent(type)}&id=${encodeURIComponent(sid)}&ext=${encodeURIComponent(ext)}`);
  return urls;
} else if(type === 'vod'){
if(ext) add(`${base}/movie/${user}/${pass}/${sid}.${ext}`);
add(`${base}/movie/${user}/${pass}/${sid}.mp4`);
} else if(type === 'live'){
if(ext) add(`${base}/live/${user}/${pass}/${sid}.${ext}`);
add(`${base}/live/${user}/${pass}/${sid}.m3u8`);
add(`${base}/live/${user}/${pass}/${sid}.ts`);
}

add(`${base}/${user}/${pass}/${sid}`);

return urls;
}


async function openSeries(seriesObj){
document.getElementById('seriesPage').style.display='block';
const content = document.getElementById('seriesContent');
content.innerHTML = '<div class="muted" style="padding:20px 0;text-align:center;">ØªØ­Ù…ÙŠÙ„ Ø­Ù„Ù‚Ø§Øª...</div>';

const titleText = seriesObj.name || seriesObj.title || 'Ø§Ù„Ù…Ø³Ù„Ø³Ù„';
document.getElementById('seriesTitleHeader').textContent = titleText;

let episodesData = seriesObj.episodes || seriesObj.videos || null;

if(!episodesData && (seriesObj.tv_series_id || seriesObj.series_id) && sessionUser){
try{
const idv = seriesObj.tv_series_id || seriesObj.series_id;
const url = `${sessionUser.server.replace(/\/$/,'')}/player_api.php?username=${encodeURIComponent(sessionUser.user)}&password=${encodeURIComponent(sessionUser.pass)}&action=get_series_info&series_id=${encodeURIComponent(idv)}`;
const json = await fetchJson(url);
episodesData = json?.episodes || extractArray(json) || null;
}catch(e){
console.warn('failed to fetch episodes', e);
}
}

if(!episodesData){
content.innerHTML = '<div class="muted" style="padding:20px 0;text-align:center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ù„Ù‚Ø§Øª Ù…ØªØ§Ø­Ø©</div>';
return;
}

let episodesBySeason = {};
if(Array.isArray(episodesData)){
episodesBySeason['1'] = episodesData;
} else if(typeof episodesData === 'object'){
Object.keys(episodesData).forEach(seasonKey=>{
const list = episodesData[seasonKey];
if(Array.isArray(list) && list.length){
episodesBySeason[seasonKey] = list;
}
});
}

const seasonKeys = Object.keys(episodesBySeason);
if(!seasonKeys.length){
content.innerHTML = '<div class="muted" style="padding:20px 0;text-align:center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ù„Ù‚Ø§Øª Ù…ØªØ§Ø­Ø©</div>';
return;
}

content.innerHTML = '';
const seasonsBar = document.createElement('div');
seasonsBar.className = 'seasonsBar';
content.appendChild(seasonsBar);

const episodesGrid = document.createElement('div');
episodesGrid.className = 'episodesGrid';
content.appendChild(episodesGrid);

let currentSeason = seasonKeys[0];

function renderSeasonsBar(){
seasonsBar.innerHTML = '';
seasonKeys.forEach(key=>{
const chip = document.createElement('div');
chip.className = 'seasonChip' + (key === currentSeason ? ' active' : '');
chip.textContent = `Ø§Ù„Ù…ÙˆØ³Ù… ${key}`;
chip.addEventListener('click', ()=>{
currentSeason = key;
renderSeasonsBar();
renderEpisodes();
});
seasonsBar.appendChild(chip);
});
}

function renderEpisodes(){
episodesGrid.innerHTML = '';
const eps = episodesBySeason[currentSeason] || [];
if(!eps.length){
episodesGrid.innerHTML = '<div class="muted" style="padding:20px 0;text-align:center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ù„Ù‚Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ³Ù…</div>';
return;
}

eps.forEach(ep=>{
const card = document.createElement('div');
card.className='episodeItem';

const thumbSrc =
(ep.info && (ep.info.movie_image || ep.info.cover || ep.info.movie_image_big)) ||
ep.stream_icon || ep.icon || ep.image ||
seriesObj.tv_series_thumb || seriesObj.cover || seriesObj.stream_icon ||
'https://via.placeholder.com/110x180?text=No+Image';

const img = document.createElement('img');
img.className = 'episodeThumb';
img.src = thumbSrc;
img.onerror = ()=>{ img.src='https://via.placeholder.com/110x180?text=No+Image'; };

const meta = document.createElement('div');
meta.className = 'episodeMeta';

const title = document.createElement('div');
title.className = 'episodeTitle';
title.textContent = ep.title||ep.name||ep.episode||'Ø­Ù„Ù‚Ø©';

meta.appendChild(title);
card.appendChild(img);
card.appendChild(meta);

card.addEventListener('click', ()=>{
closeSeries();
openPlayerOrFallback(ep,true);
});

episodesGrid.appendChild(card);
});
}

renderSeasonsBar();
renderEpisodes();
}
function closeSeries(){ document.getElementById('seriesPage').style.display='none'; }


const playerPage = document.getElementById('playerPage');
const playerEl = document.getElementById('player');
const bottomNav = document.querySelector('.bottom-nav');
let currentHls = null;
let currentPlaylist = null;
let currentIndex = 0;
let fromSeries = false;
let stoppingPlayback = false;
let isRotated = false;

// ğŸ”¥ Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù…Ø¹Ø±ÙØ© Ù‡Ù„ Ù…Ø´ØºÙ„ Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯ Ù…ØªØ§Ø­ Ø£Ù… Ù„Ø§
function hasAndroidPlayer(){
return (typeof AndroidPlayer !== 'undefined' &&
AndroidPlayer &&
typeof AndroidPlayer.playUrl === 'function');
}

const fsBtn = document.getElementById('btn-fullscreen');
if(fsBtn && playerEl){
fsBtn.addEventListener('click', ()=>{
const el = playerEl;
if(el.requestFullscreen){
el.requestFullscreen();
}else if(el.webkitRequestFullscreen){
el.webkitRequestFullscreen();
}else if(el.msRequestFullscreen){
el.msRequestFullscreen();
}
});
}

const imageViewer = document.getElementById('imageViewer');
const imageViewEl = document.getElementById('imageViewEl');

function openImageViewer(src){
if(!src) return;
imageViewEl.src = src;
imageViewer.style.display='flex';
playerPage.style.display='none';
if(bottomNav) bottomNav.style.display='none';
}
function closeImageViewer(){
imageViewEl.src = '';
imageViewer.style.display='none';
if(bottomNav) bottomNav.style.display='flex';
}

function playFromPlaylist(index){
if(stoppingPlayback) return;
if(!currentPlaylist || !currentPlaylist.length) return;

if(index >= currentPlaylist.length){
if(!stoppingPlayback){
alert('ØªØ¹Ø°Ø± ØªØ´ØºÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„Ù…ØµØ¯Ø±');
}
return;
}

currentIndex = index;
const url = currentPlaylist[index];

// ğŸ”¥ Ù„Ùˆ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø£Ù†Ø¯Ø±ÙˆÙŠØ¯ Ù…ÙˆØµÙ„ Ø§Ù„Ù€ AndroidPlayer Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø´ØºÙ„ Ø§Ù„Ù…Ø³ØªÙ‚Ù„
if (hasAndroidPlayer()) {
try {
AndroidPlayer.playUrl(url);
} catch(e){}
// Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…Ø´ØºÙ„ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ Ù„Ùˆ Ø¸Ù‡Ø±
playerPage.style.display = 'none';
if(bottomNav) bottomNav.style.display = 'flex';
return;
}

const ext = getExtFromUrl(url);
const clean = url.split('?')[0].toLowerCase();

const isImage = /\.(jpe?g|png|gif|webp|avif|bmp)$/.test(clean);
const isHls = ext === 'm3u8' || /m3u8/i.test(clean);

try{
if(currentHls){ currentHls.destroy(); currentHls=null; }
}catch(e){}
playerEl.onerror = null;

if(isImage){
playerEl.pause(); playerEl.src='';
openImageViewer(url);
return;
}

closeImageViewer();

const tryNext = ()=>{ if(stoppingPlayback) return; playFromPlaylist(index+1); };

if(isHls && window.Hls && Hls.isSupported()){
currentHls = new Hls({maxBufferLength:60});
currentHls.loadSource(url);
currentHls.attachMedia(playerEl);
currentHls.on(Hls.Events.MANIFEST_PARSED, ()=> {
if(stoppingPlayback) return;
playerEl.play().catch(()=>{});
});
currentHls.on(Hls.Events.ERROR, (ev,data)=>{
if(data && data.fatal){
try{ currentHls.destroy(); }catch(e){}
currentHls=null;
tryNext();
}
});
} else {
playerEl.src = url;
playerEl.load();
playerEl.play().catch(()=>{});
playerEl.onerror = ()=>{ tryNext(); };
}

playerPage.style.display='flex';
if(bottomNav) bottomNav.style.display = 'none';
adjustPlayerForOrientation();
}

function openPlayerOrFallback(item, isEpisodeFromSeries){
fromSeries = !!isEpisodeFromSeries;
stoppingPlayback = false;
isRotated = false;
document.body.style.overflow='';
adjustPlayerForOrientation();

if(!sessionUser){
alert('Ø³Ø¬Ù‘Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹');
return;
}

addToRecent(item);

const candidates = buildCandidateUrls(item);
if(!candidates.length){
alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ø§Ø¨Ø· ØªØ´ØºÙŠÙ„ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù†ØµØ±');
return;
}
currentPlaylist = candidates;
playFromPlaylist(0);
}

function closePlayer(){
stoppingPlayback = true;
try{
playerEl.onerror = null;
if(currentHls){ currentHls.destroy(); currentHls=null; }
playerEl.pause();
playerEl.removeAttribute('src');
playerEl.load();
}catch(e){}
currentPlaylist = null;
currentIndex = 0;
playerPage.style.display='none';
if(bottomNav) bottomNav.style.display = 'flex';
document.body.style.overflow='';
isRotated = false;

if(fromSeries){
const sPage = document.getElementById('seriesPage');
if(sPage) sPage.style.display='block';
}
fromSeries = false;

setTimeout(()=>{ stoppingPlayback = false; }, 150);
}

function toggleRotate(){
isRotated = !isRotated;
if(isRotated){
document.body.style.overflow='hidden';
}else{
document.body.style.overflow='';
}
adjustPlayerForOrientation();
}
function adjustPlayerForOrientation(){
const isLandscape = window.innerWidth > window.innerHeight;

if(isRotated){
playerEl.style.width  = '100vh';
playerEl.style.height = '100vw';
playerEl.style.objectFit = 'cover';
playerEl.style.transform = 'rotate(90deg)';
playerEl.style.transformOrigin = 'center center';
return;
}

if(isLandscape){
playerEl.style.width='100vw';
playerEl.style.height='100vh';
playerEl.style.objectFit='cover';
document.body.style.overflow='hidden';
} else {
playerEl.style.width='100%';
playerEl.style.height='auto';
playerEl.style.objectFit='contain';
document.body.style.overflow='';
}
playerEl.style.transform='none';
playerEl.style.transformOrigin='center center';
}


const carousel    = document.getElementById('carousel');
const slidesOuter = document.getElementById('slidesOuter');
const sliderDots  = document.getElementById('sliderDots');
let slidesItems   = [];
let currentSlideIndex = 0;
let sliderTimer   = null;
let currentMoreItems = [];

function renderMoreGrid(list){
const grid = document.getElementById('moreGrid');
if(!grid) return;
grid.innerHTML = '';
if(!list || !list.length){
const empty = document.createElement('div');
empty.className = 'morePage-empty muted';
empty.style.padding = '20px 0';
empty.style.textAlign = 'center';
empty.textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ± Ù…Ø·Ø§Ø¨Ù‚Ø©';
grid.appendChild(empty);
return;
}
list.forEach(it=>{
const card = document.createElement('div');
card.className = 'morePage-card';
const thumb = document.createElement('div');
thumb.className = 'morePage-thumb';
const img = document.createElement('img');
img.loading = 'lazy';
img.src = it.stream_icon || it.icon || it.tv_series_thumb || it.cover || it.poster || 'https://via.placeholder.com/320x180?text=No+Image';
img.onerror = ()=>{ img.src = 'https://via.placeholder.com/320x180?text=No+Image'; };
thumb.appendChild(img);
card.appendChild(thumb);
card.addEventListener('click', ()=>{
const t = guessSectionType(it);
if(t === 'series'){
openSeries(it);
}else{
openPlayerOrFallback(it, false);
}
});
grid.appendChild(card);
});
}

function openMorePage(title, items){
const page = document.getElementById('morePage');
const titleEl = document.getElementById('moreTitle');
const searchInput = document.getElementById('moreSearchInput');
if(!page || !titleEl) return;
currentMoreItems = Array.isArray(items) ? items.slice() : [];
titleEl.textContent = title || 'Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©';
page.style.display = 'block';
renderMoreGrid(currentMoreItems);
if(searchInput){
searchInput.value = '';
searchInput.oninput = ()=>{
const q = searchInput.value.trim().toLowerCase();
if(!q){
renderMoreGrid(currentMoreItems);
return;
}
const filtered = currentMoreItems.filter(it=>{
const name = (it.name || it.title || '').toString().toLowerCase();
return name.includes(q);
});
renderMoreGrid(filtered);
};
}
}

function closeMorePage(){
const page = document.getElementById('morePage');
if(page) page.style.display = 'none';
}

function shuffle(arr){
for(let i=arr.length-1;i>0;i--){
const j=Math.floor(Math.random()*(i+1));
const tmp=arr[i]; arr[i]=arr[j]; arr[j]=tmp;
}
}
function buildSlidesFromCache(){
let pool = cache.movies || [];

if(!pool.length){
slidesItems = [];
return;
}
const copy = pool.slice();
shuffle(copy);
slidesItems = [];

for(const it of copy){
if(slidesItems.length >= 5) break;
const img = it.stream_icon||it.icon||it.cover||it.poster;
if(!img) continue;
slidesItems.push(it);
}
}
function renderCarousel(){
slidesOuter.innerHTML = '';
sliderDots.innerHTML  = '';
currentSlideIndex = 0;
if(sliderTimer){ clearInterval(sliderTimer); sliderTimer = null; }

if(!slidesItems || !slidesItems.length){
const div = document.createElement('div');
div.className='slideItem';
div.style.backgroundImage = `linear-gradient(135deg,#1d4ed8,#111)`;
div.innerHTML = '<span class="slideTitle">Ø§Ù„Ø£Ø³Ø·ÙˆØ±Ø© TV</span><span class="slideSubtitle">Ø§Ø³ØªÙ…ØªØ¹ Ø¨Ø£ÙØ¶Ù„ Ù…Ø­ØªÙˆÙ‰</span>';
slidesOuter.appendChild(div);

const dot = document.createElement('div');
dot.className='slider-dot active';
sliderDots.appendChild(dot);
return;
}

slidesItems.forEach((it, idx)=>{
const div = document.createElement('div');
div.className='slideItem';
const img = it.stream_icon||it.icon||it.cover||it.poster||'https://via.placeholder.com/900x360?text=No+Image';
div.style.backgroundImage = `linear-gradient(120deg,rgba(0,0,0,0.05),rgba(0,0,0,0.85)),url('${img}')`;

const t1 = document.createElement('span');
t1.className='slideTitle';
t1.textContent = it.name || it.title || 'Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†';
const t2 = document.createElement('span');
t2.className='slideSubtitle';
t2.textContent = 'ÙÙŠÙ„Ù…';
div.appendChild(t1);
div.appendChild(t2);

div.addEventListener('click', ()=>{
openPlayerOrFallback(it,false);
});

slidesOuter.appendChild(div);

const dot = document.createElement('div');
dot.className='slider-dot' + (idx===0 ? ' active' : '');
dot.addEventListener('click', ()=>{ goToSlide(idx); });
sliderDots.appendChild(dot);
});

updateSliderPosition();
startSliderAutoPlay();
}
function updateSliderPosition(){
const total = slidesItems.length;
if(!total) return;
if(currentSlideIndex < 0) currentSlideIndex = total - 1;
if(currentSlideIndex >= total) currentSlideIndex = 0;

const width = carousel.clientWidth || 1;
carousel.scrollTo({
left: currentSlideIndex * width,
behavior: 'auto'
});

const dots = sliderDots.querySelectorAll('.slider-dot');
dots.forEach((d,i)=> d.classList.toggle('active', i === currentSlideIndex));
}
function goToSlide(idx){
currentSlideIndex = idx;
updateSliderPosition();
startSliderAutoPlay();
}
function startSliderAutoPlay(){
if(sliderTimer) clearInterval(sliderTimer);
if(!slidesItems || slidesItems.length <= 1) return;
sliderTimer = setInterval(()=>{
currentSlideIndex++;
updateSliderPosition();
}, 5000);
}


async function ensureSearchDataLoaded(){
if(searchDataLoaded) return;
if(!sessionUser) return;

try{
const [m,s,l] = await Promise.all([
fetchSection(sessionUser.server, sessionUser.user, sessionUser.pass, 'get_vod_streams'),
fetchSection(sessionUser.server, sessionUser.user, sessionUser.pass, 'get_series'),
fetchSection(sessionUser.server, sessionUser.user, sessionUser.pass, 'get_live_streams')
]);
searchAll.movies = m || [];
searchAll.series = s || [];
searchAll.live   = l || [];
}catch(e){
console.warn('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨Ø­Ø«', e);
}
searchDataLoaded = true;
}

async function runSearch(){
const input = document.getElementById('searchInput');
const btn   = document.getElementById('searchBtn');
if(!input) return;
const q = input.value.trim().toLowerCase();
if(!q){
searchResults = [];
renderCurrentView();
return;
}

input.disabled = true;
if(btn) btn.disabled = true;

try{
await ensureSearchDataLoaded();

const norm = s => (s||'').toString().toLowerCase();
const results = [];

const addMatch = (item,type)=>{
const name = norm(item.name || item.title || item.channel);
if(!name) return;
if(name.includes(q)){
item.__type = type;
results.push(item);
}
};

(searchAll.movies.length ? searchAll.movies : cache.movies || []).forEach(it=>addMatch(it,'vod'));
(searchAll.series || []).forEach(it=>addMatch(it,'series'));
(searchAll.live   || []).forEach(it=>addMatch(it,'live'));

searchResults = results;
}catch(e){
console.warn('search error', e);
alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¨Ø­Ø«');
}finally{
input.disabled = false;
if(btn) btn.disabled = false;
}

renderCurrentView();
}



function markActiveTabByPath(){
  const h = (location.hash || '#home').replace('#','').toLowerCase();
  let view = 'home';
  if(h === 'overlay'){
    // Ø­Ø§Ù„Ø© ÙˆØ³ÙŠØ·Ø©: Ù„Ø§ ØªØºÙŠÙ‘Ø± Ø§Ù„ØªØ§Ø¨Ø§Øª Ù‡Ù†Ø§ (ÙŠØªÙ… Ø§Ù„ØªØ­ÙƒÙ… Ù…Ù† Ù…ÙƒØ§Ù† Ø§Ù„Ø§Ø³ØªØ¯Ø¹Ø§Ø¡)
    return;
  }
  if(h === 'movies') view = 'movies';
  else if(h === 'series') view = 'series';
  else if(h === 'live') view = 'live';
  const tabs = document.querySelectorAll('.bottom-nav .tab');
  tabs.forEach(t=>{
    const v = t.dataset.view;
    t.classList.toggle('active', v === view);
  });

  // Ù„Ùˆ Ø§Ù„Ù‡Ù€Ø§Ø´ Ù…Ø´ home Ø§ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
  if(view === 'movies') loadOverlayPage('movie.html','Ø§Ù„Ø£ÙÙ„Ø§Ù…');
  else if(view === 'series') loadOverlayPage('series.html','Ø§Ù„Ù…Ø³Ù„Ø³Ù„Ø§Øª');
  else if(view === 'live') loadOverlayPage('layout/live.html','Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±');
  else {
    const overlay = document.getElementById('pageOverlay');
    const content = document.getElementById('pageOverlayContent');
    if(overlay) overlay.style.display = 'none';
    if(content) content.innerHTML = '';
    const titleEl = document.querySelector('.top-title');
    if(titleEl) titleEl.textContent = 'Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©';
  }
}

markActiveTabByPath();
window.addEventListener('popstate', markActiveTabByPath);



function loadOverlayPage(file, pageTitle){
  const overlay = document.getElementById('pageOverlay');
  const content = document.getElementById('pageOverlayContent');
  const overlayTitle = document.getElementById('pageOverlayTitle');
  const titleEl = document.querySelector('.top-title');

  if(overlayTitle) overlayTitle.textContent = pageTitle || 'Ø§Ù„Ù…Ø­ØªÙˆÙ‰';
  if(titleEl) titleEl.textContent = pageTitle || 'Ø§Ù„Ù…Ø­ØªÙˆÙ‰';

  if(!overlay || !content) return;

  content.innerHTML = '<div class="muted" style="padding:20px;text-align:center;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>';

  fetch(file, {cache:'no-store'})
    .then(r => {
      if(!r.ok) throw new Error('HTTP ' + r.status);
      return r.text();
    })
    .then(fragmentHtml => {
      // Ø¥Ø¯Ø±Ø§Ø¬ Ø§Ù„Ù€ HTML
      content.innerHTML = fragmentHtml;

      // ØªØ´ØºÙŠÙ„ Ø£ÙŠ <script> Ø¯Ø§Ø®Ù„ Ø§Ù„Ù€ fragment (innerHTML Ù„Ø§ ÙŠÙØ´ØºÙ‘Ù„ Ø§Ù„Ø³ÙƒØ±Ø¨Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹)
      const scripts = Array.from(content.querySelectorAll('script'));
      scripts.forEach(oldScript => {
        const s = document.createElement('script');
        // Ù†Ù‚Ù„ Ø§Ù„ØµÙØ§Øª
        for (const attr of oldScript.attributes) {
          s.setAttribute(attr.name, attr.value);
        }
        if(oldScript.src){
          s.src = oldScript.src;
        }else{
          s.textContent = oldScript.textContent;
        }
        oldScript.replaceWith(s);
      });

      overlay.style.display = 'flex';
    })
    .catch(() => {
      content.innerHTML = '<div class="muted" style="padding:20px;text-align:center;">ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©</div>';
      overlay.style.display = 'flex';
    });
}


document.getElementById('navInner').addEventListener('click', (ev)=>{
const tab = ev.target.closest('.tab'); if(!tab) return;
const view = tab.dataset.view;
if(!view) return;

// ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ§Ø¨ Ø§Ù„Ù…Ø¶ØºÙˆØ· ÙˆØ¥Ù„ØºØ§Ø¡ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø¨Ø§Ù‚ÙŠ
document.querySelectorAll('.bottom-nav .tab').forEach(t=>{
t.classList.toggle('active', t === tab);
});

const overlay = document.getElementById('pageOverlay');
const titleEl = document.querySelector('.top-title');
const overlayTitle = document.getElementById('pageOverlayTitle');

if(view === 'home'){
// Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ù„ÙŠ ÙÙˆÙ‚ ÙˆØ§Ù„Ø±Ø¬ÙˆØ¹ Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
history.pushState({view}, '', '#home');
if(overlay) overlay.style.display = 'none';
const content = document.getElementById('pageOverlayContent');
if(content) content.innerHTML = '';
if(titleEl) titleEl.textContent = 'Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©';
return;
}

let pageTitle = '';

if(view === 'movies'){
  pageTitle = 'Ø§Ù„Ø£ÙÙ„Ø§Ù…';
  history.pushState({view}, '', '#movies');
  loadOverlayPage('movie.html', pageTitle);
  return;
} else if(view === 'series'){
  pageTitle = 'Ø§Ù„Ù…Ø³Ù„Ø³Ù„Ø§Øª';
  history.pushState({view}, '', '#series');
  loadOverlayPage('series.html', pageTitle);
  return;
} else if(view === 'live'){
  pageTitle = 'Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±';
  history.pushState({view}, '', '#live');
  loadOverlayPage('layout/live.html', pageTitle);
  return;
}
});

// Ø²Ø±Ø§Ø± Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ù„ÙŠ ÙÙˆÙ‚
(function setupOverlayClose(){
const overlay = document.getElementById('pageOverlay');
const closeBtn = document.getElementById('closePageOverlay');
if(!overlay || !closeBtn) return;

closeBtn.addEventListener('click', ()=>{
  overlay.style.display = 'none';
  const content = document.getElementById('pageOverlayContent');
  if(content) content.innerHTML = '';
  history.pushState({view:'home'}, '', '#home');
  const homeTab = document.querySelector('.bottom-nav .tab[data-view="home"]');
  document.querySelectorAll('.bottom-nav .tab').forEach(t=>{
    t.classList.toggle('active', t === homeTab);
  });
  const titleEl = document.querySelector('.top-title');
  if(titleEl) titleEl.textContent = 'Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©';
});
})();





document.getElementById('sectionsContainer').addEventListener('click',(ev)=>{
const more = ev.target.closest('.more');
if(!more) return;

if(more.id === 'clearRecentBtn') return;

const go = more.dataset.go;
if(!go) return;

// ØµÙØ­Ø© "Ø¢Ø®Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ§Øª"
if(go === 'go:latest'){
openMorePage('Ø¢Ø®Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ§Øª', buildLatestItems());
return;
}

// ØµÙØ­Ø§Øª Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª Ù„Ù„Ø£ÙÙ„Ø§Ù…
if(go.startsWith('go:cat_')){
const id = go.substring('go:cat_'.length);
const cats = buildCategoriesForMovies();
const cat = cats.find(c => String(c.id) === String(id));
if(cat){
openMorePage(cat.name, cat.items);
}
return;
}

// Ø§ÙØªØ±Ø§Ø¶ÙŠ: Ø§ØªØ±ÙƒÙ‡ ÙŠØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ†Ù‚Ù„ Ø§Ù„Ø¹Ø§Ø¯ÙŠ (go:...)
// Ù„Ùˆ Ù‚ÙŠÙ…Ø© go Ø¨ØªØ´ÙŠØ± Ù„Ù…Ù„Ù html Ø§ÙØªØ­Ù‡ Ø¯Ø§Ø®Ù„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ø¯ÙˆÙ† Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„
if(/\.html(\?|#|$)/i.test(go)){
  // Ø¹Ù†ÙˆØ§Ù† Ø§ÙØªØ±Ø§Ø¶ÙŠ
  const ttl = (go.includes('movie') ? 'Ø§Ù„Ø£ÙÙ„Ø§Ù…' : go.includes('series') ? 'Ø§Ù„Ù…Ø³Ù„Ø³Ù„Ø§Øª' : go.includes('live') ? 'Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±' : 'Ø§Ù„Ù…Ø­ØªÙˆÙ‰');
  history.pushState({view:'overlay', src:go}, '', '#overlay');
  loadOverlayPage(go, ttl);
  return;
}

// ØºÙŠØ± Ø°Ù„Ùƒ (Ø±ÙˆØ§Ø¨Ø· Ø®Ø§Ø±Ø¬ÙŠØ©/Ø£ÙˆØ§Ù…Ø± Ø®Ø§ØµØ©) Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø§Ù„Ø¹Ø§Ø¯ÙŠ
window.location.href = go;
});


document.getElementById('searchBtn').addEventListener('click', runSearch);
document.getElementById('searchInput').addEventListener('keyup', (e)=>{
if(e.key === 'Enter') runSearch();
});


function renderCurrentView(){
const container = document.getElementById('sectionsContainer');
container.innerHTML = '';

if(searchResults.length){
renderSearchSection(container);
}

renderRecentSection(container);
renderLatestSection(container);
renderMovieCategories(container);

buildSlidesFromCache();
renderCarousel();
}


window.addEventListener('resize', ()=>{ if(playerPage.style.display==='flex') adjustPlayerForOrientation(); });
window.addEventListener('orientationchange', ()=>{ if(playerPage.style.display==='flex') adjustPlayerForOrientation(); });


document.addEventListener('DOMContentLoaded', ()=>{
const app = document.getElementById('appUI');
const blocked = document.getElementById('blocked-screen');

if(blocked) blocked.style.display = 'none';
if(app) app.style.display = 'block';

loadAllSections().catch(e => console.error('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…', e));
});

/* ======= Android Back / Browser Back handling ======= */
window.addEventListener('popstate', ()=>{
  const overlay   = document.getElementById('pageOverlay');
  const content   = document.getElementById('pageOverlayContent');
  const playerPg  = document.getElementById('playerPage');
  const seriesPg  = document.getElementById('seriesPage');
  const morePg    = document.getElementById('morePage');
  const imgViewer = document.getElementById('imageViewer');

  // Ù„Ùˆ Ø¹Ø§Ø±Ø¶ Ø§Ù„ØµÙˆØ± Ù…ÙØªÙˆØ­
  if(imgViewer && imgViewer.style.display === 'flex'){
    closeImageViewer();
    history.pushState({view:'home'}, '', '#home');
    return;
  }

  // Ù„Ùˆ Ø§Ù„Ù…Ø´ØºÙ„ Ù…ÙØªÙˆØ­
  if(playerPg && playerPg.style.display === 'flex'){
    closePlayer();
    history.pushState({view:'home'}, '', '#home');
    return;
  }

  // Ù„Ùˆ ØµÙØ­Ø© Ø§Ù„Ø­Ù„Ù‚Ø§Øª Ù…ÙØªÙˆØ­Ø©
  if(seriesPg && seriesPg.style.display === 'block'){
    closeSeries();
    history.pushState({view:'home'}, '', '#home');
    return;
  }

  // Ù„Ùˆ ØµÙØ­Ø© "Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø²ÙŠØ¯" Ù…ÙØªÙˆØ­Ø©
  if(morePg && morePg.style.display === 'block'){
    closeMorePage();
    history.pushState({view:'home'}, '', '#home');
    return;
  }

  // Ù„Ùˆ Ø§Ù„Ù€ overlay Ù…ÙØªÙˆØ­
  if(overlay && overlay.style.display === 'flex'){
    overlay.style.display = 'none';
    if(content) content.innerHTML = '';
    const titleEl = document.querySelector('.top-title');
    if(titleEl) titleEl.textContent = 'Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©';

    const homeTab = document.querySelector('.bottom-nav .tab[data-view="home"]');
    document.querySelectorAll('.bottom-nav .tab').forEach(t=>{
      t.classList.toggle('active', t === homeTab);
    });

    history.pushState({view:'home'}, '', '#home');
    return;
  }
});

</script>
</body>
</html>
